<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payee Autocomplete Tab Test</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f8fafc;
            padding: 2rem;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Mock payees data
        const mockPayees = [
            'Amazon',
            'Target',
            'Walmart',
            'Starbucks',
            'Shell Gas Station',
            'Electric Company',
            'Water Department',
            'Netflix'
        ];

        const PayeeAutocomplete = ({
            label,
            value,
            onChange,
            payees = [],
            onAddPayee,
            placeholder = "Enter payee name...",
            required = false,
            ...props
        }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [inputValue, setInputValue] = useState(value || '');
            const [filteredPayees, setFilteredPayees] = useState(payees);
            const inputRef = useRef(null);
            const dropdownRef = useRef(null);

            // Update input value when prop value changes
            useEffect(() => {
                setInputValue(value || '');
            }, [value]);

            // Filter payees based on input
            useEffect(() => {
                if (!inputValue.trim()) {
                    setFilteredPayees(payees);
                } else {
                    const filtered = payees.filter(payee =>
                        payee.toLowerCase().includes(inputValue.toLowerCase())
                    );
                    setFilteredPayees(filtered);
                }
            }, [inputValue, payees]);

            // Close dropdown when clicking outside
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };

                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const handleInputChange = (e) => {
                const newValue = e.target.value;
                setInputValue(newValue);
                onChange?.(e);
                setIsOpen(true);
            };

            const handleSelectPayee = (payee) => {
                setInputValue(payee);
                onChange?.({ target: { value: payee } });
                setIsOpen(false);
                inputRef.current?.blur();
            };

            const handleAddNewPayee = () => {
                if (inputValue.trim() && !payees.includes(inputValue.trim())) {
                    const newPayee = inputValue.trim();
                    onAddPayee?.(newPayee);
                    handleSelectPayee(newPayee);
                }
            };

            const handleKeyDown = (e) => {
                console.log('ðŸ”‘ TEST PAGE - Key pressed:', e.key, {
                    inputValue,
                    filteredPayees,
                    isOpen,
                    filteredPayeesLength: filteredPayees.length
                });

                if (e.key === 'Enter') {
                    console.log('âœ… TEST PAGE - Enter key processing...');
                    e.preventDefault();

                    const exactMatch = filteredPayees.find(payee =>
                        payee.toLowerCase() === inputValue.toLowerCase()
                    );

                    if (exactMatch) {
                        console.log('âœ… TEST PAGE - Exact match:', exactMatch);
                        handleSelectPayee(exactMatch);
                    } else if (inputValue.trim() && filteredPayees.length === 0) {
                        console.log('âœ… TEST PAGE - Adding new payee:', inputValue.trim());
                        handleAddNewPayee();
                    } else if (filteredPayees.length > 0) {
                        console.log('âœ… TEST PAGE - Selecting first option:', filteredPayees[0]);
                        handleSelectPayee(filteredPayees[0]);
                    }
                } else if (e.key === 'Tab') {
                    console.log('ðŸ”¥ TEST PAGE - TAB KEY DETECTED!', {
                        filteredPayeesLength: filteredPayees.length,
                        inputValueTrimmed: inputValue.trim(),
                        isOpen,
                        conditions: {
                            hasFilteredPayees: filteredPayees.length > 0,
                            hasInputValue: !!inputValue.trim(),
                            dropdownIsOpen: isOpen
                        }
                    });

                    // Handle Tab key for autocomplete - improved logic
                    if (filteredPayees.length > 0 && inputValue.trim() && isOpen) {
                        console.log('ðŸš€ TEST PAGE - TAB CONDITIONS MET!');
                        e.preventDefault();
                        e.stopPropagation();

                        // Find the best match (starts with the input)
                        const startsWithMatch = filteredPayees.find(payee =>
                            payee.toLowerCase().startsWith(inputValue.toLowerCase())
                        );

                        // Use the best match or first filtered option
                        const bestMatch = startsWithMatch || filteredPayees[0];
                        console.log('ðŸŽ¯ TEST PAGE - Best match:', bestMatch, {
                            startsWithMatch,
                            firstFiltered: filteredPayees[0]
                        });

                        handleSelectPayee(bestMatch);

                        // Ensure the dropdown closes and input loses focus
                        setTimeout(() => {
                            console.log('ðŸ”„ TEST PAGE - Cleanup complete');
                            setIsOpen(false);
                            inputRef.current?.blur();
                        }, 0);
                    } else {
                        console.log('âŒ TEST PAGE - TAB CONDITIONS NOT MET:', {
                            hasFilteredPayees: filteredPayees.length > 0,
                            hasInputValue: !!inputValue.trim(),
                            dropdownIsOpen: isOpen
                        });
                    }
                } else if (e.key === 'Escape') {
                    console.log('ðŸ”„ TEST PAGE - Escape key');
                    setIsOpen(false);
                    inputRef.current?.blur();
                }
            };

            const showAddOption = inputValue.trim() &&
                !payees.some(payee => payee.toLowerCase() === inputValue.toLowerCase()) &&
                filteredPayees.length === 0;

            return (
                <div className="relative" ref={dropdownRef}>
                    {label && (
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            {label}
                            {required && <span className="text-red-500 ml-1">*</span>}
                        </label>
                    )}

                    <div className="relative">
                        <input
                            ref={inputRef}
                            type="text"
                            value={inputValue}
                            onChange={handleInputChange}
                            onFocus={() => setIsOpen(true)}
                            onKeyDown={handleKeyDown}
                            placeholder={placeholder}
                            required={required}
                            className="w-full px-3 py-2 pr-10 border border-gray-400 rounded-lg 
                                     bg-white text-gray-900 placeholder-gray-500
                                     focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
                                     transition-colors"
                            {...props}
                        />

                        <button
                            type="button"
                            onClick={() => setIsOpen(!isOpen)}
                            className="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
                        >
                            <svg className={`w-4 h-4 transition-transform ${isOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                    </div>

                    {/* Dropdown */}
                    {isOpen && (
                        <div className="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                            {/* Existing payees */}
                            {filteredPayees.length > 0 && (
                                <div>
                                    {filteredPayees.map((payee, index) => (
                                        <button
                                            key={index}
                                            type="button"
                                            onClick={() => handleSelectPayee(payee)}
                                            className="w-full px-3 py-2 text-left hover:bg-gray-100 text-gray-900 transition-colors first:rounded-t-lg last:rounded-b-lg"
                                        >
                                            {payee}
                                        </button>
                                    ))}
                                </div>
                            )}

                            {/* Add new payee option */}
                            {showAddOption && (
                                <button
                                    type="button"
                                    onClick={handleAddNewPayee}
                                    className="w-full px-3 py-2 text-left hover:bg-blue-50 text-blue-600 transition-colors border-t border-gray-200 flex items-center space-x-2"
                                >
                                    <span>+</span>
                                    <span>Add "{inputValue}"</span>
                                </button>
                            )}

                            {/* No results */}
                            {filteredPayees.length === 0 && !showAddOption && inputValue.trim() && (
                                <div className="px-3 py-2 text-gray-500 text-sm">
                                    No payees found
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const TestApp = () => {
            const [payees, setPayees] = useState(mockPayees);
            const [selectedPayee, setSelectedPayee] = useState('');

            const handleAddPayee = (newPayee) => {
                setPayees(prev => [...prev, newPayee]);
            };

            const handlePayeeChange = (e) => {
                setSelectedPayee(e.target.value);
            };

            return (
                <div className="container">
                    <h1 className="text-2xl font-bold text-gray-900 mb-6">
                        Payee Autocomplete Tab Test
                    </h1>

                    <div className="space-y-4">
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h2 className="font-semibold text-blue-900 mb-2">How to Test Tab Autocomplete:</h2>
                            <ol className="text-sm text-blue-800 space-y-1">
                                <li>1. Type "Ama" in the input field below</li>
                                <li>2. You'll see "Amazon" appear in the dropdown</li>
                                <li>3. Press <kbd className="bg-blue-200 px-1 rounded">Tab</kbd> key</li>
                                <li>4. "Amazon" should be automatically selected!</li>
                            </ol>
                        </div>

                        <PayeeAutocomplete
                            label="Payee"
                            value={selectedPayee}
                            onChange={handlePayeeChange}
                            payees={payees}
                            onAddPayee={handleAddPayee}
                            placeholder="Type 'Ama' and press Tab..."
                        />

                        <div className="mt-4 p-3 bg-gray-50 rounded-lg">
                            <p className="text-sm text-gray-600">
                                <strong>Selected Payee:</strong> {selectedPayee || 'None'}
                            </p>
                        </div>

                        <div className="mt-4">
                            <h3 className="font-medium text-gray-900 mb-2">Available Payees:</h3>
                            <div className="flex flex-wrap gap-2">
                                {payees.map((payee, index) => (
                                    <span key={index} className="px-2 py-1 bg-gray-200 text-gray-700 rounded text-sm">
                                        {payee}
                                    </span>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<TestApp />, document.getElementById('root'));
    </script>
</body>

</html>