<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Budgie 🦜</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ensure dark mode works */
        .dark {
            color-scheme: dark;
        }

        /* Custom gradient backgrounds for categories */
        .bg-gradient-to-r.from-purple-500.to-pink-500 {
            background: linear-gradient(to right, #8b5cf6, #ec4899);
        }

        .bg-gradient-to-r.from-pink-500.to-blue-500 {
            background: linear-gradient(to right, #ec4899, #3b82f6);
        }

        .bg-gradient-to-r.from-orange-500.to-red-600 {
            background: linear-gradient(to right, #f97316, #dc2626);
        }

        .bg-gradient-to-r.from-green-500.to-yellow-400 {
            background: linear-gradient(to right, #22c55e, #facc15);
        }

        .bg-gradient-to-r.from-pink-500.to-red-500 {
            background: linear-gradient(to right, #ec4899, #ef4444);
        }

        .bg-gradient-to-r.from-yellow-400.to-orange-500 {
            background: linear-gradient(to right, #facc15, #f97316);
        }

        .bg-gradient-to-r.from-purple-600.to-teal-500 {
            background: linear-gradient(to right, #9333ea, #14b8a6);
        }

        .bg-gradient-to-r.from-violet-600.to-purple-800 {
            background: linear-gradient(to right, #7c3aed, #6b21a8);
        }

        /* Custom pastel backgrounds for dark mode */
        .dark .bg-red-100 {
            background-color: #fecaca !important;
        }

        .dark .bg-yellow-100 {
            background-color: #fef3c7 !important;
        }

        .dark .bg-green-100 {
            background-color: #dcfce7 !important;
        }

        .dark .text-red-900 {
            color: #7f1d1d !important;
        }

        .dark .text-yellow-900 {
            color: #78350f !important;
        }

        .dark .text-green-900 {
            color: #14532d !important;
        }

        /* Fix light mode calendar colors */
        .bg-red-100 {
            background-color: #fee2e2 !important;
        }

        .bg-yellow-100 {
            background-color: #fef3c7 !important;
        }

        .bg-green-100 {
            background-color: #dcfce7 !important;
        }

        .bg-blue-100 {
            background-color: #dbeafe !important;
        }

        .bg-purple-100 {
            background-color: #e9d5ff !important;
        }

        .bg-cyan-100 {
            background-color: #cffafe !important;
        }

        .text-red-900 {
            color: #7f1d1d !important;
        }

        .text-yellow-900 {
            color: #78350f !important;
        }

        .text-green-900 {
            color: #14532d !important;
        }

        .text-blue-900 {
            color: #1e3a8a !important;
        }

        .text-purple-900 {
            color: #581c87 !important;
        }

        .text-cyan-900 {
            color: #164e63 !important;
        }

        .border-red-400 {
            border-color: #f87171 !important;
        }

        .border-yellow-400 {
            border-color: #facc15 !important;
        }

        .border-green-400 {
            border-color: #4ade80 !important;
        }

        .border-blue-400 {
            border-color: #60a5fa !important;
        }

        .border-purple-400 {
            border-color: #a78bfa !important;
        }

        .border-cyan-400 {
            border-color: #22d3ee !important;
        }

        .border-l-green-400 {
            border-left-color: #4ade80 !important;
        }

        .border-l-yellow-400 {
            border-left-color: #facc15 !important;
        }

        .border-l-red-400 {
            border-left-color: #f87171 !important;
        }

        .border-l-blue-400 {
            border-left-color: #60a5fa !important;
        }

        .border-l-purple-400 {
            border-left-color: #a78bfa !important;
        }

        .border-l-cyan-400 {
            border-left-color: #22d3ee !important;
        }

        .border-blue-500 {
            border-color: #3b82f6 !important;
        }

        .border-gray-300 {
            border-color: #d1d5db !important;
        }

        /* Fallback styling */
        body {
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // Lucide React Icons (simplified)
        const Plus = () => (
            <svg
                className="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M12 4v16m8-8H4"
                />
            </svg>
        );
        const Download = () => (
            <svg
                className="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                />
            </svg>
        );
        const Moon = () => (
            <svg
                className="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                />
            </svg>
        );
        const Sun = () => (
            <svg
                className="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                />
            </svg>
        );
        const Edit2 = () => (
            <svg
                className="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                />
            </svg>
        );
        const Trash2 = () => (
            <svg
                className="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                />
            </svg>
        );
        const Calculator = () => (
            <svg
                className="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"
                />
            </svg>
        );
        const Target = () => (
            <svg
                className="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <circle cx="12" cy="12" r="10" />
                <circle cx="12" cy="12" r="6" />
                <circle cx="12" cy="12" r="2" />
            </svg>
        );
        const DollarSign = () => (
            <svg
                className="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <line x1="12" y1="1" x2="12" y2="23" />
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
            </svg>
        );
        const ChevronDown = () => (
            <svg
                className="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <polyline points="6,9 12,15 18,9" />
            </svg>
        );
        const ChevronRight = () => (
            <svg
                className="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <polyline points="9,18 15,12 9,6" />
            </svg>
        );
        const ChevronUp = () => (
            <svg
                className="w-3 h-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <polyline points="18,15 12,9 6,15" />
            </svg>
        );
        const Eye = () => (
            <svg
                className="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                <circle cx="12" cy="12" r="3" />
            </svg>
        );
        const Percent = () => (
            <svg
                className="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <line x1="19" y1="5" x2="5" y2="19" />
                <circle cx="6.5" cy="6.5" r="2.5" />
                <circle cx="17.5" cy="17.5" r="2.5" />
            </svg>
        );

        // LocalStorage utilities
        const useLocalStorage = (key, initialValue) => {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.error(`Error reading localStorage key "${key}":`, error);
                    return initialValue;
                }
            });

            const setValue = (value) => {
                try {
                    const valueToStore =
                        value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) {
                    console.error(`Error setting localStorage key "${key}":`, error);
                }
            };

            return [storedValue, setValue];
        };

        // Transaction Form Component
        const AddTransactionForm = ({
            onSave,
            onCancel,
            categories,
            accounts,
            darkMode,
            transaction = null,
        }) => {
            const [formData, setFormData] = useState({
                date: transaction?.date || new Date().toISOString().split("T")[0],
                payee: transaction?.payee || "",
                amount: transaction?.amount || "",
                categoryId: transaction?.categoryId || categories[0]?.id || 1,
                accountId: transaction?.accountId || accounts[0]?.id || 1,
                memo: transaction?.memo || "",
                cleared: transaction?.cleared || false,
                transfer: transaction?.transfer || false,
                transferAccountId: transaction?.transferAccountId || "",
            });

            const handleKeyDown = (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    if (e.shiftKey) {
                        handleSubmit(true);
                    } else {
                        handleSubmit(false);
                    }
                } else if (e.key === "Escape") {
                    onCancel();
                }
            };

            const handleSubmit = (addAnother = false) => {
                if (
                    formData.date &&
                    formData.amount &&
                    (formData.payee || formData.transfer)
                ) {
                    onSave(
                        {
                            ...formData,
                            amount: parseFloat(formData.amount),
                            categoryId: formData.transfer
                                ? null
                                : parseInt(formData.categoryId),
                            accountId: parseInt(formData.accountId),
                            transferAccountId: formData.transfer
                                ? parseInt(formData.transferAccountId)
                                : null,
                        },
                        addAnother
                    );

                    if (addAnother) {
                        setFormData({
                            date: formData.date,
                            payee: "",
                            amount: "",
                            categoryId: formData.categoryId,
                            accountId: formData.accountId,
                            memo: "",
                            cleared: false,
                            transfer: false,
                            transferAccountId: "",
                        });
                        setTimeout(() => {
                            const payeeInput = document.querySelector(
                                'input[placeholder="Payee"]'
                            );
                            if (payeeInput) payeeInput.focus();
                        }, 100);
                    }
                }
            };

            return (
                <div className="space-y-4" onKeyDown={handleKeyDown}>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium mb-1">Date</label>
                            <input
                                type="date"
                                value={formData.date}
                                onChange={(e) =>
                                    setFormData((prev) => ({ ...prev, date: e.target.value }))
                                }
                                className={`w-full p-2 border rounded ${darkMode
                                    ? "bg-gray-700 border-gray-600"
                                    : "bg-white border-gray-300"
                                    }`}
                                style={darkMode ? { colorScheme: "dark" } : {}}
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium mb-1">
                                Account
                            </label>
                            <select
                                value={formData.accountId}
                                onChange={(e) =>
                                    setFormData((prev) => ({
                                        ...prev,
                                        accountId: e.target.value,
                                    }))
                                }
                                className={`w-full p-2 border rounded ${darkMode
                                    ? "bg-gray-700 border-gray-600"
                                    : "bg-white border-gray-300"
                                    }`}
                            >
                                {accounts.map((account) => (
                                    <option key={account.id} value={account.id}>
                                        {account.name}
                                    </option>
                                ))}
                            </select>
                        </div>
                    </div>

                    <div className="flex items-center">
                        <input
                            type="checkbox"
                            id="transferCheckbox"
                            checked={formData.transfer}
                            onChange={(e) =>
                                setFormData((prev) => ({
                                    ...prev,
                                    transfer: e.target.checked,
                                    payee: "",
                                    categoryId: categories[0]?.id,
                                }))
                            }
                            className="mr-2"
                        />
                        <label htmlFor="transferCheckbox" className="text-sm">
                            This is a transfer between accounts
                        </label>
                    </div>

                    {formData.transfer ? (
                        <div>
                            <label className="block text-sm font-medium mb-1">
                                Transfer To Account
                            </label>
                            <select
                                value={formData.transferAccountId}
                                onChange={(e) =>
                                    setFormData((prev) => ({
                                        ...prev,
                                        transferAccountId: e.target.value,
                                    }))
                                }
                                className={`w-full p-2 border rounded ${darkMode
                                    ? "bg-gray-700 border-gray-600"
                                    : "bg-white border-gray-300"
                                    }`}
                            >
                                <option value="">Select account...</option>
                                {accounts
                                    .filter((acc) => acc.id !== parseInt(formData.accountId))
                                    .map((account) => (
                                        <option key={account.id} value={account.id}>
                                            {account.name}
                                        </option>
                                    ))}
                            </select>
                        </div>
                    ) : (
                        <>
                            <div>
                                <label className="block text-sm font-medium mb-1">
                                    Payee
                                </label>
                                <input
                                    type="text"
                                    value={formData.payee}
                                    onChange={(e) =>
                                        setFormData((prev) => ({
                                            ...prev,
                                            payee: e.target.value,
                                        }))
                                    }
                                    placeholder="Payee"
                                    className={`w-full p-2 border rounded ${darkMode
                                        ? "bg-gray-700 border-gray-600"
                                        : "bg-white border-gray-300"
                                        }`}
                                    autoFocus={!transaction}
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-1">
                                    Category
                                </label>
                                <select
                                    value={formData.categoryId}
                                    onChange={(e) =>
                                        setFormData((prev) => ({
                                            ...prev,
                                            categoryId: e.target.value,
                                        }))
                                    }
                                    className={`w-full p-2 border rounded ${darkMode
                                        ? "bg-gray-700 border-gray-600"
                                        : "bg-white border-gray-300"
                                        }`}
                                >
                                    {categories.map((cat) => (
                                        <option key={cat.id} value={cat.id}>
                                            {cat.name}
                                        </option>
                                    ))}
                                </select>
                            </div>
                        </>
                    )}

                    <div>
                        <label className="block text-sm font-medium mb-1">Amount</label>
                        <input
                            type="number"
                            step="0.01"
                            value={formData.amount}
                            onChange={(e) =>
                                setFormData((prev) => ({ ...prev, amount: e.target.value }))
                            }
                            placeholder="0.00"
                            className={`w-full p-2 border rounded ${darkMode
                                ? "bg-gray-700 border-gray-600"
                                : "bg-white border-gray-300"
                                }`}
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium mb-1">
                            Memo (Optional)
                        </label>
                        <input
                            type="text"
                            value={formData.memo}
                            onChange={(e) =>
                                setFormData((prev) => ({ ...prev, memo: e.target.value }))
                            }
                            placeholder="Additional details..."
                            className={`w-full p-2 border rounded ${darkMode
                                ? "bg-gray-700 border-gray-600"
                                : "bg-white border-gray-300"
                                }`}
                        />
                    </div>

                    <div className="flex items-center">
                        <input
                            type="checkbox"
                            id="clearedCheckbox"
                            checked={formData.cleared}
                            onChange={(e) =>
                                setFormData((prev) => ({
                                    ...prev,
                                    cleared: e.target.checked,
                                }))
                            }
                            className="mr-2"
                        />
                        <label htmlFor="clearedCheckbox" className="text-sm">
                            Cleared/Reconciled
                        </label>
                    </div>

                    <div className="flex space-x-2">
                        <button
                            onClick={() => handleSubmit(false)}
                            className="flex-1 bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700"
                            disabled={
                                !formData.date ||
                                !formData.amount ||
                                (!formData.payee && !formData.transfer)
                            }
                        >
                            {transaction ? "Update" : "Add"} Transaction
                        </button>
                        <button
                            onClick={() => handleSubmit(true)}
                            className="bg-green-600 text-white py-2 px-3 rounded hover:bg-green-700"
                            disabled={
                                !formData.date ||
                                !formData.amount ||
                                (!formData.payee && !formData.transfer)
                            }
                            title="Save and add another (Shift+Enter)"
                        >
                            +
                        </button>
                        <button
                            onClick={onCancel}
                            className={`py-2 px-4 rounded border ${darkMode ? "border-gray-600" : "border-gray-300"
                                }`}
                        >
                            Cancel
                        </button>
                    </div>

                    <div className="text-xs text-gray-500 mt-2">
                        💡 Press Enter to save • Shift+Enter to save & add another •
                        Escape to cancel
                    </div>
                </div>
            );
        };

        // Add Expense Form Component
        const AddExpenseForm = ({
            onSave,
            onCancel,
            categories,
            darkMode,
            expense = null,
            currentPay,
            preselectedCategory,
        }) => {
            const [formData, setFormData] = useState({
                name: expense?.name || "",
                amount: expense?.amount || "",
                percentage: "",
                inputMode: "amount",
                frequency: expense?.frequency || "monthly",
                categoryId:
                    expense?.categoryId ||
                    preselectedCategory ||
                    categories[0]?.id ||
                    1,
                priority: expense?.priority || "important",
                alreadySaved: expense?.alreadySaved || 0,
                dueDate: expense?.dueDate || "",
                allocationPaused: expense?.allocationPaused || false,
                isRecurringExpense: expense?.isRecurringExpense || false,
                priorityState:
                    expense?.priorityState ||
                    (expense?.allocationPaused ? "paused" : "active"),
            });

            useEffect(() => {
                if (
                    formData.inputMode === "percentage" &&
                    formData.percentage &&
                    !formData.amount
                ) {
                    const calculatedAmount =
                        (parseFloat(formData.percentage) / 100) * currentPay;
                    setFormData((prev) => ({
                        ...prev,
                        amount: calculatedAmount.toFixed(2),
                    }));
                } else if (
                    formData.inputMode === "amount" &&
                    formData.amount &&
                    !formData.percentage
                ) {
                    const calculatedPercentage =
                        (parseFloat(formData.amount) / currentPay) * 100;
                    setFormData((prev) => ({
                        ...prev,
                        percentage: calculatedPercentage.toFixed(2),
                    }));
                }
            }, [
                formData.percentage,
                formData.amount,
                formData.inputMode,
                currentPay,
            ]);

            const handleKeyDown = (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    if (e.shiftKey) {
                        handleSubmit(true);
                    } else {
                        handleSubmit(false);
                    }
                } else if (e.key === "Escape") {
                    onCancel();
                }
            };

            const handleSubmit = (addAnother = false) => {
                if (formData.name && (formData.amount || formData.percentage)) {
                    const finalAmount =
                        formData.inputMode === "percentage"
                            ? (parseFloat(formData.percentage) / 100) * currentPay
                            : parseFloat(formData.amount);

                    onSave(
                        {
                            ...formData,
                            amount: finalAmount,
                            categoryId: parseInt(formData.categoryId),
                            alreadySaved: parseFloat(formData.alreadySaved) || 0,
                        },
                        addAnother
                    );

                    if (addAnother) {
                        setFormData({
                            name: "",
                            amount: "",
                            percentage: "",
                            inputMode: formData.inputMode,
                            frequency: formData.frequency,
                            categoryId: formData.categoryId,
                            priority: formData.priority,
                            alreadySaved: 0,
                            dueDate: "",
                            allocationPaused: false,
                        });
                        setTimeout(() => {
                            const nameInput = document.querySelector(
                                'input[placeholder="Expense name"]'
                            );
                            if (nameInput) nameInput.focus();
                        }, 100);
                    }
                }
            };

            const remainingNeeded = Math.max(
                0,
                (parseFloat(formData.amount) || 0) -
                (parseFloat(formData.alreadySaved) || 0)
            );
            const fundingProgress =
                formData.amount > 0
                    ? ((parseFloat(formData.alreadySaved) || 0) /
                        parseFloat(formData.amount)) *
                    100
                    : 0;

            return (
                <div className="space-y-4" onKeyDown={handleKeyDown}>
                    <input
                        type="text"
                        value={formData.name}
                        onChange={(e) =>
                            setFormData((prev) => ({ ...prev, name: e.target.value }))
                        }
                        placeholder="Expense name"
                        className={`w-full p-2 border rounded ${darkMode
                            ? "bg-gray-700 border-gray-600"
                            : "bg-white border-gray-300"
                            }`}
                        autoFocus
                    />

                    <div className="space-y-2">
                        <div className="flex space-x-2">
                            <button
                                type="button"
                                onClick={() =>
                                    setFormData((prev) => ({
                                        ...prev,
                                        inputMode: "amount",
                                        percentage: "",
                                    }))
                                }
                                className={`flex-1 py-1 px-3 rounded text-sm ${formData.inputMode === "amount"
                                    ? "bg-blue-600 text-white"
                                    : `${darkMode ? "bg-gray-700" : "bg-gray-200"}`
                                    }`}
                            >
                                $ Amount
                            </button>
                            <button
                                type="button"
                                onClick={() =>
                                    setFormData((prev) => ({
                                        ...prev,
                                        inputMode: "percentage",
                                        amount: "",
                                    }))
                                }
                                className={`flex-1 py-1 px-3 rounded text-sm ${formData.inputMode === "percentage"
                                    ? "bg-green-600 text-white"
                                    : `${darkMode ? "bg-gray-700" : "bg-gray-200"}`
                                    }`}
                            >
                                % of Paycheck
                            </button>
                        </div>

                        {formData.inputMode === "amount" ? (
                            <input
                                type="number"
                                step="0.01"
                                value={formData.amount}
                                onChange={(e) =>
                                    setFormData((prev) => ({
                                        ...prev,
                                        amount: e.target.value,
                                        percentage: "",
                                    }))
                                }
                                placeholder="Amount"
                                className={`w-full p-2 border rounded ${darkMode
                                    ? "bg-gray-700 border-gray-600"
                                    : "bg-white border-gray-300"
                                    }`}
                            />
                        ) : (
                            <div className="relative">
                                <input
                                    type="number"
                                    step="0.1"
                                    value={formData.percentage}
                                    onChange={(e) =>
                                        setFormData((prev) => ({
                                            ...prev,
                                            percentage: e.target.value,
                                            amount: "",
                                        }))
                                    }
                                    placeholder="Percentage of paycheck"
                                    className={`w-full p-2 border rounded ${darkMode
                                        ? "bg-gray-700 border-gray-600"
                                        : "bg-white border-gray-300"
                                        }`}
                                />
                                <span className="absolute right-3 top-3 text-gray-400">
                                    %
                                </span>
                            </div>
                        )}

                        {formData.percentage && formData.inputMode === "percentage" && (
                            <div className="text-xs text-gray-500">
                                ≈ $
                                {(
                                    (parseFloat(formData.percentage) / 100) *
                                    currentPay
                                ).toFixed(2)}{" "}
                                per paycheck
                            </div>
                        )}
                        {formData.amount && formData.inputMode === "amount" && (
                            <div className="text-xs text-gray-500">
                                ≈{" "}
                                {((parseFloat(formData.amount) / currentPay) * 100).toFixed(
                                    1
                                )}
                                % of paycheck
                            </div>
                        )}
                    </div>

                    <select
                        name="frequency"
                        value={formData.frequency}
                        onChange={(e) =>
                            setFormData((prev) => ({ ...prev, frequency: e.target.value }))
                        }
                        className={`w-full p-2 border rounded ${darkMode
                            ? "bg-gray-700 border-gray-600"
                            : "bg-white border-gray-300"
                            }`}
                    >
                        <option value="weekly">Weekly</option>
                        <option value="bi-weekly">Bi-weekly</option>
                        <option value="every-3-weeks">Every 3 weeks</option>
                        <option value="monthly">Monthly</option>
                        <option value="every-6-weeks">Every 6 weeks</option>
                        <option value="every-7-weeks">Every 7 weeks</option>
                        <option value="every-8-weeks">Every 8 weeks</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="annually">Annually</option>
                        <option value="per-paycheck">Per Paycheck (Direct)</option>
                    </select>

                    <div className="space-y-3 p-4 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600">
                        <h4 className="font-medium text-gray-900 dark:text-gray-100">
                            💰 Funding Status
                        </h4>

                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">
                                    Already Saved
                                </label>
                                <input
                                    type="number"
                                    step="0.01"
                                    value={formData.alreadySaved}
                                    onChange={(e) =>
                                        setFormData((prev) => ({
                                            ...prev,
                                            alreadySaved: e.target.value,
                                        }))
                                    }
                                    placeholder="0.00"
                                    className={`w-full p-2 border rounded text-sm ${darkMode
                                        ? "bg-gray-800 border-gray-600 text-gray-100"
                                        : "bg-white border-gray-300 text-gray-900"
                                        }`}
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">
                                    Due Date (Optional)
                                </label>
                                <input
                                    type="date"
                                    value={formData.dueDate}
                                    onChange={(e) =>
                                        setFormData((prev) => ({
                                            ...prev,
                                            dueDate: e.target.value,
                                        }))
                                    }
                                    className={`w-full p-2 border rounded text-sm ${darkMode
                                        ? "bg-gray-800 border-gray-600 text-gray-100"
                                        : "bg-white border-gray-300 text-gray-900"
                                        }`}
                                    style={darkMode ? { colorScheme: "dark" } : {}}
                                />
                            </div>
                        </div>

                        {formData.amount && formData.alreadySaved > 0 && (
                            <div className="space-y-2">
                                <div className="flex justify-between text-sm text-gray-700 dark:text-gray-300">
                                    <span>
                                        Progress: $
                                        {parseFloat(formData.alreadySaved || 0).toFixed(2)} / $
                                        {parseFloat(formData.amount || 0).toFixed(2)}
                                    </span>
                                    <span className="font-medium">
                                        {fundingProgress.toFixed(0)}%
                                    </span>
                                </div>
                                <div className="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                    <div
                                        className={`h-2 rounded-full ${fundingProgress >= 100 ? "bg-green-500" : "bg-blue-500"
                                            }`}
                                        style={{ width: `${Math.min(100, fundingProgress)}%` }}
                                    ></div>
                                </div>
                                <div className="text-sm text-gray-600 dark:text-gray-400">
                                    Remaining needed: ${remainingNeeded.toFixed(2)}
                                    {fundingProgress >= 100 && (
                                        <span className="text-green-600 dark:text-green-400 font-medium">
                                            {" "}
                                            ✓ Fully funded!
                                        </span>
                                    )}
                                </div>
                            </div>
                        )}

                        <div>
                            <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Priority Status</label>
                            <div className="flex space-x-1">
                                <button
                                    type="button"
                                    onClick={() => setFormData(prev => ({ ...prev, priorityState: 'active' }))}
                                    className={`flex-1 py-1 px-2 rounded text-sm font-medium transition-colors ${formData.priorityState === 'active'
                                        ? 'bg-blue-500 text-white border border-blue-500'
                                        : darkMode
                                            ? 'border border-gray-600 hover:bg-gray-700 text-gray-300'
                                            : 'border border-gray-300 hover:bg-gray-50 text-gray-700'
                                        }`}
                                >
                                    🟢 Active
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setFormData(prev => ({ ...prev, priorityState: 'paused' }))}
                                    className={`flex-1 py-1 px-2 rounded text-sm font-medium transition-colors ${formData.priorityState === 'paused'
                                        ? 'bg-blue-500 text-white border border-blue-500'
                                        : darkMode
                                            ? 'border border-gray-600 hover:bg-gray-700 text-gray-300'
                                            : 'border border-gray-300 hover:bg-gray-50 text-gray-700'
                                        }`}
                                >
                                    ⏸️ Paused
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setFormData(prev => ({ ...prev, priorityState: 'complete' }))}
                                    className={`flex-1 py-1 px-2 rounded text-sm font-medium transition-colors ${formData.priorityState === 'complete'
                                        ? 'bg-blue-500 text-white border border-blue-500'
                                        : darkMode
                                            ? 'border border-gray-600 hover:bg-gray-700 text-gray-300'
                                            : 'border border-gray-300 hover:bg-gray-50 text-gray-700'
                                        }`}
                                >
                                    ✅ Funded
                                </button>
                            </div>
                            <div className="text-xs text-gray-500 mt-2">
                                Active: Allocate money • Paused: Track only • Complete: Goal reached
                            </div>
                        </div>
                        <div className="flex items-center">
                            <input
                                type="checkbox"
                                id="recurringExpense"
                                checked={formData.isRecurringExpense}
                                onChange={(e) =>
                                    setFormData((prev) => ({
                                        ...prev,
                                        isRecurringExpense: e.target.checked,
                                    }))
                                }
                                className="mr-2"
                            />
                            <label
                                htmlFor="recurringExpense"
                                className="text-sm text-gray-700 dark:text-gray-300"
                            >
                                This is a recurring expense
                            </label>
                        </div>
                    </div>

                    <select
                        name="categoryId"
                        value={formData.categoryId}
                        onChange={(e) =>
                            setFormData((prev) => ({
                                ...prev,
                                categoryId: parseInt(e.target.value),
                            }))
                        }
                        className={`w-full p-2 border rounded ${darkMode
                            ? "bg-gray-700 border-gray-600"
                            : "bg-white border-gray-300"
                            }`}
                    >
                        {categories.map((cat) => (
                            <option key={cat.id} value={cat.id}>
                                {cat.name}
                            </option>
                        ))}
                    </select>

                    <select
                        value={formData.priority}
                        onChange={(e) =>
                            setFormData((prev) => ({ ...prev, priority: e.target.value }))
                        }
                        className={`w-full p-2 border rounded ${darkMode
                            ? "bg-gray-700 border-gray-600"
                            : "bg-white border-gray-300"
                            }`}
                    >
                        <option value="essential">Essential</option>
                        <option value="important">Important</option>
                        <option value="nice-to-have">Nice to Have</option>
                    </select>

                    <div className="flex space-x-2">
                        <button
                            onClick={() => handleSubmit(false)}
                            className="flex-1 bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700"
                            disabled={
                                !formData.name || (!formData.amount && !formData.percentage)
                            }
                        >
                            {expense ? "Update" : "Add"} Expense
                        </button>
                        <button
                            onClick={() => handleSubmit(true)}
                            className="bg-green-600 text-white py-2 px-3 rounded hover:bg-green-700"
                            disabled={
                                !formData.name || (!formData.amount && !formData.percentage)
                            }
                            title="Save and add another (Shift+Enter)"
                        >
                            +
                        </button>
                        <button
                            onClick={onCancel}
                            className={`py-2 px-4 rounded border ${darkMode ? "border-gray-600" : "border-gray-300"
                                }`}
                        >
                            Cancel
                        </button>
                    </div>

                    <div className="text-xs text-gray-500 mt-2">
                        💡 Press Enter to save • Shift+Enter to save & add another •
                        Escape to cancel
                    </div>
                </div>
            );
        };

        // Add Category Form Component
        const AddCategoryForm = ({
            onSave,
            onCancel,
            categoryColors,
            darkMode,
            category = null,
        }) => {
            const [formData, setFormData] = useState({
                name: category?.name || "",
                color: category?.color || categoryColors[0],
            });

            const handleKeyDown = (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    if (e.shiftKey) {
                        handleSubmit(true);
                    } else {
                        handleSubmit(false);
                    }
                } else if (e.key === "Escape") {
                    onCancel();
                }
            };

            const handleSubmit = (addAnother = false) => {
                if (formData.name) {
                    onSave(formData, addAnother);
                    if (addAnother) {
                        setFormData({
                            name: "",
                            color: categoryColors[0],
                        });
                        setTimeout(() => {
                            const nameInput = document.querySelector(
                                'input[placeholder="Category name"]'
                            );
                            if (nameInput) nameInput.focus();
                        }, 100);
                    }
                }
            };

            return (
                <div className="space-y-4" onKeyDown={handleKeyDown}>
                    <input
                        type="text"
                        value={formData.name}
                        onChange={(e) =>
                            setFormData((prev) => ({ ...prev, name: e.target.value }))
                        }
                        placeholder="Category name"
                        className={`w-full p-2 border rounded ${darkMode
                            ? "bg-gray-700 border-gray-600"
                            : "bg-white border-gray-300"
                            }`}
                        autoFocus
                    />

                    <div>
                        <label className="block text-sm font-medium mb-2">Color</label>
                        <div className="grid grid-cols-2 gap-3">
                            {categoryColors.map((color, index) => (
                                <button
                                    key={color}
                                    type="button"
                                    onClick={() => setFormData((prev) => ({ ...prev, color }))}
                                    className={`h-12 rounded-lg ${color} border-3 ${formData.color === color
                                        ? "border-blue-500 ring-2 ring-blue-300"
                                        : "border-transparent hover:border-gray-400"
                                        } shadow-lg transition-all duration-200 hover:scale-105 flex items-center justify-center`}
                                    title={`Aurora Gradient ${index + 1}`}
                                >
                                    <div className="w-full h-full rounded-md opacity-80"></div>
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="flex space-x-2">
                        <button
                            onClick={() => handleSubmit(false)}
                            className="flex-1 bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700"
                            disabled={!formData.name}
                        >
                            {category ? "Update" : "Add"} Category
                        </button>
                        <button
                            onClick={() => handleSubmit(true)}
                            className="bg-green-600 text-white py-2 px-3 rounded hover:bg-green-700"
                            disabled={!formData.name}
                            title="Save and add another (Shift+Enter)"
                        >
                            +
                        </button>
                        <button
                            onClick={onCancel}
                            className={`py-2 px-4 rounded border ${darkMode ? "border-gray-600" : "border-gray-300"
                                }`}
                        >
                            Cancel
                        </button>
                    </div>

                    <div className="text-xs text-gray-500 mt-2">
                        💡 Press Enter to save • Shift+Enter to save & add another •
                        Escape to cancel
                    </div>
                </div>
            );
        };

        // Generate Paycheck Dates
        const generatePaycheckDates = (paySchedule) => {
            console.log(
                "generatePaycheckDates called with:",
                paySchedule.startDate
            );

            const dates = [];
            const [year, month, day] = paySchedule.startDate.split("-").map(Number);
            const startDate = new Date(year, month - 1, day);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let currentDate = new Date(startDate);
            const daysBetween = paySchedule.frequency === "bi-weekly" ? 14 : 30;

            // Move currentDate to first future paycheck
            let safetyCount = 0;
            while (currentDate < today && safetyCount < 100) {
                currentDate.setDate(currentDate.getDate() + daysBetween);
                safetyCount++;
            }

            // Generate next 10 paychecks
            for (let i = 0; i < 26; i++) {
                dates.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + daysBetween);
            }

            console.log(`Generated ${dates.length} paycheck dates`);
            return dates;
        };

        // PaycheckEventsWithSplit

        const generatePaycheckEventsWithSplit = (
            paySchedule,
            currentPay,
            accounts
        ) => {
            const events = [];
            const primaryDates = generatePaycheckDates(paySchedule);

            primaryDates.forEach((date, index) => {
                const primaryAmount = paySchedule.splitPaycheck
                    ? paySchedule.primaryAmount
                    : currentPay;
                const primaryAccount = accounts.find(
                    (acc) => acc.id === paySchedule.primaryAccountId
                );

                // Add primary paycheck
                events.push({
                    date: new Date(date),
                    type: "paycheck",
                    subtype: "primary",
                    title: paySchedule.splitPaycheck
                        ? `${primaryAccount?.name || "Primary Bank"}`
                        : `Paycheck #${index + 1}`,
                    amount: primaryAmount,
                    description: `${paySchedule.splitPaycheck ? "Main deposit" : "Bi-weekly income"
                        }: $${primaryAmount.toFixed(2)}${primaryAccount ? ` → ${primaryAccount.name}` : ""
                        }`,
                    accountId: paySchedule.splitPaycheck
                        ? paySchedule.primaryAccountId
                        : null,
                });

                // Add secondary paycheck if split is enabled
                if (paySchedule.splitPaycheck && paySchedule.secondaryAmount > 0) {
                    const secondaryDate = new Date(date);
                    secondaryDate.setDate(
                        date.getDate() - paySchedule.secondaryDaysEarly
                    );
                    const secondaryAccount = accounts.find(
                        (acc) => acc.id === paySchedule.secondaryAccountId
                    );

                    events.push({
                        date: secondaryDate,
                        type: "paycheck",
                        subtype: "secondary",
                        title: `${secondaryAccount?.name || "Secondary Bank"}`,
                        amount: paySchedule.secondaryAmount,
                        description: `Early deposit: $${paySchedule.secondaryAmount.toFixed(
                            2
                        )} (${paySchedule.secondaryDaysEarly} days early) → ${secondaryAccount?.name || "Secondary Bank"
                            }`,
                        accountId: paySchedule.secondaryAccountId,
                    });
                }
            });

            return events.sort((a, b) => a.date - b.date);
        };
        const generateCalendarEvents = (
            paySchedule,
            currentPay,
            savingsGoals,
            expenses,
            categories,
            frequencyOptions,
            accounts
        ) => {
            const events = [];
            const paycheckEvents = generatePaycheckEventsWithSplit(
                paySchedule,
                currentPay,
                accounts
            );
            events.push(...paycheckEvents);

            // Add goal deadlines
            savingsGoals.forEach((goal) => {
                if (goal.targetDate) {
                    const [year, month, day] = goal.targetDate.split("-").map(Number);
                    const deadline = new Date(year, month - 1, day);

                    events.push({
                        date: deadline,
                        type: "goal-deadline",
                        title: goal.name,
                        amount: goal.targetAmount,
                        description: `Target: $${goal.targetAmount.toLocaleString()}`,
                        category: categories.find((c) => c.id === goal.categoryId)?.name,
                        isRecurring: false,
                        occurrenceNumber: 1,
                    });
                }
            });

            // Generate recurring expense due dates
            expenses.forEach((expense) => {
                if (expense.dueDate) {
                    try {
                        const [year, month, day] = expense.dueDate.split("-").map(Number);
                        const firstDueDate = new Date(year, month - 1, day);

                        if (
                            expense.isRecurringExpense &&
                            expense.frequency &&
                            expense.frequency !== "per-paycheck"
                        ) {
                            const freqData = frequencyOptions.find(
                                (f) => f.value === expense.frequency
                            );
                            if (freqData && freqData.weeksPerYear > 0) {
                                const daysBetween = Math.round(365 / freqData.weeksPerYear);
                                let currentDate = new Date(firstDueDate);
                                const endDate = new Date(
                                    Date.now() + 365 * 24 * 60 * 60 * 1000
                                );
                                let occurrenceCount = 1;

                                while (currentDate <= endDate && occurrenceCount <= 8) {
                                    events.push({
                                        date: new Date(currentDate),
                                        type: "expense-due",
                                        title: expense.name,
                                        amount: expense.amount,
                                        description: `$${expense.amount} due`,
                                        category: categories.find(
                                            (c) => c.id === expense.categoryId
                                        )?.name,
                                        isRecurring: true,
                                        occurrenceNumber: occurrenceCount,
                                    });

                                    currentDate = new Date(
                                        currentDate.getTime() + daysBetween * 24 * 60 * 60 * 1000
                                    );
                                    occurrenceCount++;
                                }
                            }
                        } else {
                            // Single occurrence
                            events.push({
                                date: firstDueDate,
                                type: "expense-due",
                                title: expense.name,
                                amount: expense.amount,
                                description: `$${expense.amount} due`,
                                category: categories.find((c) => c.id === expense.categoryId)
                                    ?.name,
                                isRecurring: false,
                                occurrenceNumber: 1,
                            });
                        }
                    } catch (error) {
                        console.error(
                            "Error processing expense date:",
                            expense.name,
                            error
                        );
                    }
                }
            });

            console.log(
                "Generated events:",
                events.filter((e) => e.type === "expense-due")
            );
            console.log(
                "Expenses with due dates:",
                expenses.filter((e) => e.dueDate)
            );

            return events.sort((a, b) => a.date - b.date);
        };

        const CalendarView = ({
            events,
            darkMode,
            currentPay,
            paySchedule,
            savingsGoals,
            expenses,
            categories,
            frequencyOptions,
            accounts,
        }) => {
            const [calendarView, setCalendarView] = useState("timeline");
            const [currentMonth, setCurrentMonth] = useState(new Date());

            const formatDate = (date) => {
                return date.toLocaleDateString("en-US", {
                    weekday: "short",
                    month: "short",
                    day: "numeric",
                    year:
                        date.getFullYear() !== new Date().getFullYear()
                            ? "numeric"
                            : undefined,
                });
            };

            const getEventIcon = (
                type,
                isFirstOccurrence = true,
                isRecurring = false
            ) => {
                switch (type) {
                    case "paycheck":
                        return "💰";
                    case "goal-deadline":
                        return "🎯";
                    case "expense-due":
                        return isRecurring ? "🔄" : "⏰";
                    case "recurring-transaction":
                        return "🔄";
                    default:
                        return "📅";
                }
            };

            const getEventColor = (type, subtype, warning = false) => {
                if (warning)
                    return "border-red-400 bg-red-100 dark:bg-red-900/30 text-red-900 dark:text-red-100";

                if (type === "paycheck") {
                    return subtype === "secondary"
                        ? "border-blue-400 bg-blue-100 dark:bg-blue-900/30 text-blue-900 dark:text-blue-100"
                        : "border-green-400 bg-green-100 dark:bg-green-900/30 text-green-900 dark:text-green-100";
                }
                switch (type) {
                    case "goal-deadline":
                        return "border-purple-400 bg-purple-100 dark:bg-purple-900/30 text-purple-900 dark:text-purple-100";
                    case "expense-due":
                        return "border-yellow-400 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-900 dark:text-yellow-100";
                    case "recurring-transaction":
                        return "border-cyan-400 bg-cyan-100 dark:bg-cyan-900/30 text-cyan-900 dark:text-cyan-100";
                    default:
                        return "border-gray-400 bg-gray-100 dark:bg-gray-900/30";
                }
            };

            // Grid calendar functions
            const getDaysInMonth = (date) => {
                return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            };

            const getFirstDayOfMonth = (date) => {
                return new Date(date.getFullYear(), date.getMonth(), 1).getDay();
            };

            const getEventsForDate = (date, events) => {
                return events.filter((event) => {
                    const eventDate = new Date(event.date);
                    return eventDate.toDateString() === date.toDateString();
                });
            };

            const generateCalendarGrid = (events) => {
                const daysInMonth = getDaysInMonth(currentMonth);
                const firstDay = getFirstDayOfMonth(currentMonth);
                const days = [];

                // Add empty cells for days before the first day of the month
                for (let i = 0; i < firstDay; i++) {
                    days.push(null);
                }

                // Add all days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(
                        currentMonth.getFullYear(),
                        currentMonth.getMonth(),
                        day
                    );
                    const dayEvents = getEventsForDate(date, events);
                    const isToday = date.toDateString() === new Date().toDateString();

                    days.push({
                        date,
                        day,
                        events: dayEvents,
                        isToday,
                    });
                }

                return days;
            };

            const nextMonth = () => {
                setCurrentMonth(
                    new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1)
                );
            };

            const prevMonth = () => {
                setCurrentMonth(
                    new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1)
                );
            };

            const resetToCurrentMonth = () => {
                setCurrentMonth(new Date());
            };

            // Generate the actual events
            const calendarEvents = generateCalendarEvents(
                paySchedule,
                currentPay,
                savingsGoals,
                expenses,
                categories,
                frequencyOptions,
                accounts
            );

            // Legend component (shared between both views)
            const Legend = () => (
                <div className="flex flex-wrap gap-4 text-sm border-t pt-4 mt-4">
                    <div className="flex items-center">
                        <span className="mr-1">💰</span>
                        <span>Paycheck</span>
                    </div>
                    <div className="flex items-center">
                        <span className="mr-1">🎯</span>
                        <span>Goal Deadline</span>
                    </div>
                    <div className="flex items-center">
                        <span className="mr-1">⏰</span>
                        <span>Single Expense</span>
                    </div>
                    <div className="flex items-center">
                        <span className="mr-1">🔄</span>
                        <span>Recurring Item</span>
                    </div>
                </div>
            );

            if (calendarView === "grid") {
                const calendarDays = generateCalendarGrid(calendarEvents);
                const monthNames = [
                    "January",
                    "February",
                    "March",
                    "April",
                    "May",
                    "June",
                    "July",
                    "August",
                    "September",
                    "October",
                    "November",
                    "December",
                ];
                const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

                return (
                    <div className="space-y-4">
                        <div className="flex justify-between items-center">
                            <div className="flex items-center space-x-4">
                                <h4 className="font-medium">Calendar View</h4>
                                <div className="flex space-x-2">
                                    <button
                                        onClick={() => setCalendarView("grid")}
                                        className={`px-3 py-1 rounded text-sm font-medium ${calendarView === "grid"
                                            ? "bg-purple-500 text-white"
                                            : darkMode
                                                ? "bg-gray-700 text-gray-300 hover:bg-gray-600"
                                                : "bg-gray-200 text-gray-700 hover:bg-gray-300"
                                            }`}
                                    >
                                        Grid
                                    </button>
                                    <button
                                        onClick={() => setCalendarView("timeline")}
                                        className={`px-3 py-1 rounded text-sm font-medium ${calendarView === "timeline"
                                            ? "bg-purple-500 text-white"
                                            : darkMode
                                                ? "bg-gray-700 text-gray-300 hover:bg-gray-600"
                                                : "bg-gray-200 text-gray-700 hover:bg-gray-300"
                                            }`}
                                    >
                                        Timeline
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Month Navigation */}
                        <div className="flex justify-between items-center">
                            <button
                                onClick={prevMonth}
                                className={`p-2 rounded ${darkMode ? "hover:bg-gray-700" : "hover:bg-gray-200"
                                    }`}
                            >
                                ←
                            </button>
                            <div className="flex items-center space-x-2">
                                <h3
                                    className={`text-lg font-semibold ${darkMode ? "text-gray-100" : "text-gray-900"
                                        }`}
                                >
                                    {monthNames[currentMonth.getMonth()]}{" "}
                                    {currentMonth.getFullYear()}
                                </h3>
                                <button
                                    onClick={resetToCurrentMonth}
                                    className={`text-sm hover:underline ${darkMode ? "text-blue-400" : "text-blue-600"
                                        }`}
                                >
                                    Today
                                </button>
                            </div>
                            <button
                                onClick={nextMonth}
                                className={`p-2 rounded ${darkMode ? "hover:bg-gray-700" : "hover:bg-gray-200"
                                    }`}
                            >
                                →
                            </button>
                        </div>

                        {/* Calendar Grid */}
                        <div className="grid grid-cols-7 gap-1">
                            {/* Day headers */}
                            {dayNames.map((day) => (
                                <div
                                    key={day}
                                    className={`p-2 text-center font-medium text-sm ${darkMode ? "text-gray-400" : "text-gray-500"
                                        }`}
                                >
                                    {day}
                                </div>
                            ))}

                            {/* Calendar days */}
                            {calendarDays.map((dayData, index) => (
                                <div
                                    key={index}
                                    className={`min-h-24 p-1 border ${darkMode ? "border-gray-600" : "border-gray-200"
                                        } ${dayData
                                            ? dayData.isToday
                                                ? darkMode
                                                    ? "bg-blue-900/30 text-blue-300"
                                                    : "bg-blue-50 text-blue-600"
                                                : darkMode
                                                    ? "bg-gray-800 text-gray-100"
                                                    : "bg-white text-gray-900"
                                            : darkMode
                                                ? "bg-gray-900"
                                                : "bg-gray-50"
                                        }`}
                                >
                                    {dayData && (
                                        <>
                                            <div
                                                className={`text-sm font-medium ${dayData.isToday
                                                    ? darkMode
                                                        ? "text-blue-300"
                                                        : "text-blue-600"
                                                    : darkMode
                                                        ? "text-gray-100"
                                                        : "text-gray-900"
                                                    }`}
                                            >
                                                {dayData.day}
                                            </div>
                                            <div className="space-y-1 mt-1">
                                                {dayData.events
                                                    .slice(0, 3)
                                                    .map((event, eventIndex) => (
                                                        <div
                                                            key={eventIndex}
                                                            className={`text-xs p-1 rounded truncate ${getEventColor(
                                                                event.type,
                                                                event.subtype,
                                                                event.warning
                                                            )}`}
                                                        >
                                                            <span className="mr-1">
                                                                {getEventIcon(
                                                                    event.type,
                                                                    event.occurrenceNumber === 1,
                                                                    event.isRecurring
                                                                )}
                                                            </span>
                                                            {/* Remove occurrence number from title */}
                                                            {event.title.replace(/ \(#\d+\)/, "")}
                                                        </div>
                                                    ))}
                                                {dayData.events.length > 3 && (
                                                    <div
                                                        className={`text-xs ${darkMode ? "text-gray-400" : "text-gray-500"
                                                            }`}
                                                    >
                                                        +{dayData.events.length - 3} more
                                                    </div>
                                                )}
                                            </div>
                                        </>
                                    )}
                                </div>
                            ))}
                        </div>

                        <Legend />
                    </div>
                );
            }

            // Timeline view
            const groupedEvents = calendarEvents.reduce((acc, event) => {
                const dateKey = event.date.toDateString();
                if (!acc[dateKey]) acc[dateKey] = [];
                acc[dateKey].push(event);
                return acc;
            }, {});

            const sortedDates = Object.keys(groupedEvents).sort(
                (a, b) => new Date(a) - new Date(b)
            );

            return (
                <div className="space-y-4">
                    <div className="flex justify-between items-center">
                        <div className="flex items-center space-x-4">
                            <h4 className="font-medium">Timeline View</h4>
                            <div className="flex space-x-2">
                                <button
                                    onClick={() => setCalendarView("grid")}
                                    className={`px-3 py-1 rounded text-sm font-medium ${calendarView === "grid"
                                        ? "bg-purple-500 text-white"
                                        : darkMode
                                            ? "bg-gray-700 text-gray-300 hover:bg-gray-600"
                                            : "bg-gray-200 text-gray-700 hover:bg-gray-300"
                                        }`}
                                >
                                    Grid
                                </button>
                                <button
                                    onClick={() => setCalendarView("timeline")}
                                    className={`px-3 py-1 rounded text-sm font-medium ${calendarView === "timeline"
                                        ? "bg-purple-500 text-white"
                                        : darkMode
                                            ? "bg-gray-700 text-gray-300 hover:bg-gray-600"
                                            : "bg-gray-200 text-gray-700 hover:bg-gray-300"
                                        }`}
                                >
                                    Timeline
                                </button>
                            </div>
                        </div>
                        <div className="text-sm text-gray-500">Next few months</div>
                    </div>

                    <div className="space-y-3 max-h-96 overflow-y-auto">
                        {sortedDates.slice(0, 20).map((dateKey) => {
                            const date = new Date(dateKey);
                            const dayEvents = groupedEvents[dateKey];
                            const isToday =
                                date.toDateString() === new Date().toDateString();

                            return (
                                <div
                                    key={dateKey}
                                    className={`border-l-4 pl-4 ${isToday
                                        ? "border-blue-500"
                                        : "border-gray-300 dark:border-gray-600"
                                        }`}
                                >
                                    <div
                                        className={`font-medium text-sm ${isToday ? "text-blue-600 dark:text-blue-400" : ""
                                            }`}
                                    >
                                        {formatDate(date)} {isToday && "(Today)"}
                                    </div>

                                    <div className="space-y-2 mt-2">
                                        {dayEvents.map((event, index) => (
                                            <div
                                                key={index}
                                                className={`p-3 rounded border-l-4 ${getEventColor(
                                                    event.type,
                                                    event.subtype,
                                                    event.warning
                                                )}`}
                                            >
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center">
                                                        <span className="mr-2 text-lg">
                                                            {getEventIcon(
                                                                event.type,
                                                                event.occurrenceNumber === 1,
                                                                event.isRecurring
                                                            )}
                                                        </span>
                                                        <div>
                                                            {/* Remove occurrence number from title */}
                                                            <div className="font-medium">
                                                                {event.title.replace(/ \(#\d+\)/, "")}
                                                            </div>
                                                            <div className="text-sm">
                                                                {event.description}
                                                            </div>
                                                        </div>
                                                        {event.warning && (
                                                            <span className="ml-2 text-red-500">⚠️</span>
                                                        )}
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="font-semibold">
                                                            ${event.amount.toLocaleString()}
                                                        </div>
                                                        {event.paychecksLeft !== undefined && (
                                                            <div className="text-xs">
                                                                {event.paychecksLeft} paychecks left
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                {event.category && (
                                                    <div className="text-xs text-gray-500 mt-1">
                                                        Category: {event.category}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    <Legend />
                </div>
            );
        };

        // Add Goal Form
        const GoalForm = ({
            onSave,
            onCancel,
            categories,
            darkMode,
            goal = null,
            currentPay,
            preselectedCategory,
        }) => {
            const [formData, setFormData] = useState({
                name: goal?.name || "",
                targetAmount: goal?.targetAmount || "",
                monthlyContribution: goal?.monthlyContribution || "",
                monthlyPercentage: "",
                inputMode: "amount",
                targetDate: goal?.targetDate || "",
                categoryId:
                    goal?.categoryId || preselectedCategory || categories[0]?.id || 1,
                alreadySaved: goal?.alreadySaved || 0,
                allocationPaused: goal?.allocationPaused || false,
                priorityState:
                    goal?.priorityState ||
                    (goal?.allocationPaused ? "paused" : "active"),
            });

            useEffect(() => {
                const {
                    targetAmount,
                    monthlyContribution,
                    targetDate,
                    monthlyPercentage,
                    inputMode,
                    alreadySaved,
                } = formData;

                if (
                    inputMode === "percentage" &&
                    monthlyPercentage &&
                    !monthlyContribution
                ) {
                    const calculatedAmount =
                        (parseFloat(monthlyPercentage) / 100) * currentPay * (12 / 26);
                    setFormData((prev) => ({
                        ...prev,
                        monthlyContribution: calculatedAmount.toFixed(2),
                    }));
                } else if (
                    inputMode === "amount" &&
                    monthlyContribution &&
                    !monthlyPercentage
                ) {
                    const biweeklyAmount = (parseFloat(monthlyContribution) * 12) / 26;
                    const calculatedPercentage = (biweeklyAmount / currentPay) * 100;
                    setFormData((prev) => ({
                        ...prev,
                        monthlyPercentage: calculatedPercentage.toFixed(2),
                    }));
                }

                const remainingAmount = Math.max(
                    0,
                    (parseFloat(targetAmount) || 0) - (parseFloat(alreadySaved) || 0)
                );

                if (
                    targetDate &&
                    targetAmount &&
                    !monthlyContribution &&
                    !monthlyPercentage &&
                    remainingAmount > 0
                ) {
                    const today = new Date();
                    const target = new Date(targetDate);
                    const monthsUntilTarget = Math.max(
                        1,
                        (target - today) / (1000 * 60 * 60 * 24 * 30.44)
                    );
                    const requiredMonthly = remainingAmount / monthsUntilTarget;

                    if (requiredMonthly > 0 && isFinite(requiredMonthly)) {
                        setFormData((prev) => ({
                            ...prev,
                            monthlyContribution: requiredMonthly.toFixed(2),
                        }));
                    }
                } else if (targetDate && monthlyContribution && !targetAmount) {
                    const today = new Date();
                    const target = new Date(targetDate);
                    const monthsUntilTarget = Math.max(
                        1,
                        (target - today) / (1000 * 60 * 60 * 24 * 30.44)
                    );
                    const possibleAmount =
                        parseFloat(monthlyContribution) * monthsUntilTarget +
                        (parseFloat(alreadySaved) || 0);

                    if (possibleAmount > 0 && isFinite(possibleAmount)) {
                        setFormData((prev) => ({
                            ...prev,
                            targetAmount: possibleAmount.toFixed(2),
                        }));
                    }
                }
            }, [
                formData.targetAmount,
                formData.monthlyContribution,
                formData.targetDate,
                formData.monthlyPercentage,
                formData.inputMode,
                formData.alreadySaved,
                currentPay,
            ]);

            const handleKeyDown = (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    if (e.shiftKey) {
                        handleSubmit(true);
                    } else {
                        handleSubmit(false);
                    }
                } else if (e.key === "Escape") {
                    onCancel();
                }
            };

            const handleSubmit = (addAnother = false) => {
                if (
                    formData.name &&
                    formData.targetAmount &&
                    (formData.monthlyContribution || formData.monthlyPercentage) &&
                    formData.targetDate
                ) {
                    const finalMonthlyContribution =
                        formData.inputMode === "percentage"
                            ? (parseFloat(formData.monthlyPercentage) / 100) *
                            currentPay *
                            (12 / 26)
                            : parseFloat(formData.monthlyContribution);

                    onSave(
                        {
                            ...formData,
                            targetAmount: parseFloat(formData.targetAmount),
                            monthlyContribution: finalMonthlyContribution,
                            categoryId: parseInt(formData.categoryId),
                            alreadySaved: parseFloat(formData.alreadySaved) || 0,
                        },
                        addAnother
                    );

                    if (addAnother) {
                        setFormData({
                            name: "",
                            targetAmount: "",
                            monthlyContribution: "",
                            monthlyPercentage: "",
                            inputMode: formData.inputMode,
                            targetDate: "",
                            categoryId: formData.categoryId,
                            alreadySaved: 0,
                            allocationPaused: false,
                        });
                        setTimeout(() => {
                            const nameInput = document.querySelector(
                                'input[placeholder="Goal name"]'
                            );
                            if (nameInput) nameInput.focus();
                        }, 100);
                    }
                }
            };

            const remainingNeeded = Math.max(
                0,
                (parseFloat(formData.targetAmount) || 0) -
                (parseFloat(formData.alreadySaved) || 0)
            );
            const fundingProgress =
                formData.targetAmount > 0
                    ? ((parseFloat(formData.alreadySaved) || 0) /
                        parseFloat(formData.targetAmount)) *
                    100
                    : 0;

            return (
                <div className="space-y-4" onKeyDown={handleKeyDown}>
                    <input
                        type="text"
                        value={formData.name}
                        onChange={(e) =>
                            setFormData((prev) => ({ ...prev, name: e.target.value }))
                        }
                        placeholder="Goal name"
                        className={`w-full p-2 border rounded ${darkMode
                            ? "bg-gray-700 border-gray-600"
                            : "bg-white border-gray-300"
                            }`}
                        autoFocus
                    />

                    <input
                        type="date"
                        value={formData.targetDate}
                        onChange={(e) =>
                            setFormData((prev) => ({ ...prev, targetDate: e.target.value }))
                        }
                        className={`w-full p-2 border rounded ${darkMode
                            ? "bg-gray-700 border-gray-600"
                            : "bg-white border-gray-300"
                            }`}
                        style={darkMode ? { colorScheme: "dark" } : {}}
                    />

                    <div className="grid grid-cols-2 gap-4">
                        <input
                            type="number"
                            step="0.01"
                            value={formData.targetAmount}
                            onChange={(e) =>
                                setFormData((prev) => ({
                                    ...prev,
                                    targetAmount: e.target.value,
                                    monthlyContribution: "",
                                    monthlyPercentage: "",
                                }))
                            }
                            placeholder="Target amount"
                            className={`w-full p-2 border rounded ${darkMode
                                ? "bg-gray-700 border-gray-600"
                                : "bg-white border-gray-300"
                                }`}
                        />

                        <div className="space-y-2">
                            <div className="flex space-x-1">
                                <button
                                    type="button"
                                    onClick={() =>
                                        setFormData((prev) => ({
                                            ...prev,
                                            inputMode: "amount",
                                            monthlyPercentage: "",
                                        }))
                                    }
                                    className={`flex-1 py-1 px-2 rounded text-xs ${formData.inputMode === "amount"
                                        ? "bg-blue-600 text-white"
                                        : `${darkMode ? "bg-gray-700" : "bg-gray-200"}`
                                        }`}
                                >
                                    $
                                </button>
                                <button
                                    type="button"
                                    onClick={() =>
                                        setFormData((prev) => ({
                                            ...prev,
                                            inputMode: "percentage",
                                            monthlyContribution: "",
                                        }))
                                    }
                                    className={`flex-1 py-1 px-2 rounded text-xs ${formData.inputMode === "percentage"
                                        ? "bg-green-600 text-white"
                                        : `${darkMode ? "bg-gray-700" : "bg-gray-200"}`
                                        }`}
                                >
                                    %
                                </button>
                            </div>

                            {formData.inputMode === "amount" ? (
                                <input
                                    type="number"
                                    step="0.01"
                                    value={formData.monthlyContribution}
                                    onChange={(e) =>
                                        setFormData((prev) => ({
                                            ...prev,
                                            monthlyContribution: e.target.value,
                                            targetAmount: "",
                                            monthlyPercentage: "",
                                        }))
                                    }
                                    placeholder="Monthly amount"
                                    className={`w-full p-2 border rounded ${darkMode
                                        ? "bg-gray-700 border-gray-600"
                                        : "bg-white border-gray-300"
                                        }`}
                                />
                            ) : (
                                <div className="relative">
                                    <input
                                        type="number"
                                        step="0.1"
                                        value={formData.monthlyPercentage}
                                        onChange={(e) =>
                                            setFormData((prev) => ({
                                                ...prev,
                                                monthlyPercentage: e.target.value,
                                                monthlyContribution: "",
                                                targetAmount: "",
                                            }))
                                        }
                                        placeholder="% per paycheck"
                                        className={`w-full p-2 border rounded ${darkMode
                                            ? "bg-gray-700 border-gray-600"
                                            : "bg-white border-gray-300"
                                            }`}
                                    />
                                    <span className="absolute right-3 top-3 text-gray-400">
                                        %
                                    </span>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="space-y-3 p-4 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600">
                        <h4 className="font-medium text-gray-900 dark:text-gray-100">
                            🎯 Progress Tracking
                        </h4>

                        <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">
                                Already Saved
                            </label>
                            <input
                                type="number"
                                step="0.01"
                                value={formData.alreadySaved}
                                onChange={(e) =>
                                    setFormData((prev) => ({
                                        ...prev,
                                        alreadySaved: e.target.value,
                                    }))
                                }
                                placeholder="0.00"
                                className={`w-full p-2 border rounded text-sm ${darkMode
                                    ? "bg-gray-800 border-gray-600 text-gray-100"
                                    : "bg-white border-gray-300 text-gray-900"
                                    }`}
                            />
                        </div>

                        {formData.targetAmount && formData.alreadySaved > 0 && (
                            <div className="space-y-2">
                                <div className="flex justify-between text-sm text-gray-700 dark:text-gray-300">
                                    <span>
                                        Progress: $
                                        {parseFloat(formData.alreadySaved || 0).toLocaleString()}{" "}
                                        / $
                                        {parseFloat(formData.targetAmount || 0).toLocaleString()}
                                    </span>
                                    <span className="font-medium">
                                        {fundingProgress.toFixed(0)}%
                                    </span>
                                </div>
                                <div className="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                    <div
                                        className={`h-2 rounded-full ${fundingProgress >= 100 ? "bg-green-500" : "bg-green-400"
                                            }`}
                                        style={{ width: `${Math.min(100, fundingProgress)}%` }}
                                    ></div>
                                </div>
                                <div className="text-sm text-gray-600 dark:text-gray-400">
                                    Remaining needed: ${remainingNeeded.toLocaleString()}
                                    {fundingProgress >= 100 && (
                                        <span className="text-green-600 dark:text-green-400 font-medium">
                                            {" "}
                                            ✓ Goal reached!
                                        </span>
                                    )}
                                </div>
                            </div>
                        )}

                        <div>
                            <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Priority Status</label>
                            <div className="flex space-x-1">
                                <button
                                    type="button"
                                    onClick={() => setFormData(prev => ({ ...prev, priorityState: 'active' }))}
                                    className={`flex-1 py-1 px-2 rounded text-sm font-medium transition-colors ${formData.priorityState === 'active'
                                        ? 'bg-blue-500 text-white border border-blue-500'
                                        : darkMode
                                            ? 'border border-gray-600 hover:bg-gray-700 text-gray-300'
                                            : 'border border-gray-300 hover:bg-gray-50 text-gray-700'
                                        }`}
                                >
                                    🟢 Active
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setFormData(prev => ({ ...prev, priorityState: 'paused' }))}
                                    className={`flex-1 py-1 px-2 rounded text-sm font-medium transition-colors ${formData.priorityState === 'paused'
                                        ? 'bg-blue-500 text-white border border-blue-500'
                                        : darkMode
                                            ? 'border border-gray-600 hover:bg-gray-700 text-gray-300'
                                            : 'border border-gray-300 hover:bg-gray-50 text-gray-700'
                                        }`}
                                >
                                    ⏸️ Paused
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setFormData(prev => ({ ...prev, priorityState: 'complete' }))}
                                    className={`flex-1 py-1 px-2 rounded text-sm font-medium transition-colors ${formData.priorityState === 'complete'
                                        ? 'bg-blue-500 text-white border border-blue-500'
                                        : darkMode
                                            ? 'border border-gray-600 hover:bg-gray-700 text-gray-300'
                                            : 'border border-gray-300 hover:bg-gray-50 text-gray-700'
                                        }`}
                                >
                                    ✅ Funded
                                </button>
                            </div>
                            <div className="text-xs text-gray-500 mt-2">
                                Active: Allocate money • Paused: Track only • Complete: Goal reached
                            </div>
                        </div>
                    </div>

                    <div className="text-xs text-gray-500">
                        Fill any two fields and the third calculates automatically
                    </div>

                    <select
                        value={formData.categoryId}
                        onChange={(e) =>
                            setFormData((prev) => ({
                                ...prev,
                                categoryId: parseInt(e.target.value),
                            }))
                        }
                        className={`w-full p-2 border rounded ${darkMode
                            ? "bg-gray-700 border-gray-600"
                            : "bg-white border-gray-300"
                            }`}
                    >
                        {categories.map((cat) => (
                            <option key={cat.id} value={cat.id}>
                                {cat.name}
                            </option>
                        ))}
                    </select>

                    <div className="flex space-x-2">
                        <button
                            onClick={() => handleSubmit(false)}
                            className="flex-1 bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700"
                            disabled={
                                !formData.targetAmount ||
                                (!formData.monthlyContribution &&
                                    !formData.monthlyPercentage) ||
                                !formData.name ||
                                !formData.targetDate
                            }
                        >
                            {goal ? "Update" : "Add"} Goal
                        </button>
                        <button
                            onClick={() => handleSubmit(true)}
                            className="bg-green-600 text-white py-2 px-3 rounded hover:bg-green-700"
                            disabled={
                                !formData.targetAmount ||
                                (!formData.monthlyContribution &&
                                    !formData.monthlyPercentage) ||
                                !formData.name ||
                                !formData.targetDate
                            }
                            title="Save and add another (Shift+Enter)"
                        >
                            +
                        </button>
                        <button
                            onClick={onCancel}
                            className={`py-2 px-4 rounded border ${darkMode ? "border-gray-600" : "border-gray-300"
                                }`}
                        >
                            Cancel
                        </button>
                    </div>

                    <div className="text-xs text-gray-500 mt-2">
                        💡 Press Enter to save • Shift+Enter to save & add another •
                        Escape to cancel
                    </div>
                </div>
            );
        };
        // Add Account Form Component
        const AddAccountForm = ({
            onSave,
            onCancel,
            darkMode,
            account = null,
        }) => {
            const [formData, setFormData] = useState({
                name: account?.name || "",
                type: account?.type || "checking",
                balance: account?.balance || "",
                bankName: account?.bankName || "",
            });

            const handleKeyDown = (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    handleSubmit();
                } else if (e.key === "Escape") {
                    onCancel();
                }
            };

            const handleSubmit = () => {
                if (formData.name && formData.balance !== "") {
                    onSave({
                        ...formData,
                        balance: parseFloat(formData.balance) || 0,
                    });
                }
            };

            return (
                <div className="space-y-4" onKeyDown={handleKeyDown}>
                    <input
                        type="text"
                        value={formData.name}
                        onChange={(e) =>
                            setFormData((prev) => ({ ...prev, name: e.target.value }))
                        }
                        placeholder="Account name (e.g., 'Main Checking')"
                        className={`w-full p-2 border rounded ${darkMode
                            ? "bg-gray-700 border-gray-600"
                            : "bg-white border-gray-300"
                            }`}
                        autoFocus
                    />

                    <select
                        value={formData.type}
                        onChange={(e) =>
                            setFormData((prev) => ({ ...prev, type: e.target.value }))
                        }
                        className={`w-full p-2 border rounded ${darkMode
                            ? "bg-gray-700 border-gray-600"
                            : "bg-white border-gray-300"
                            }`}
                    >
                        <option value="checking">Checking</option>
                        <option value="savings">Savings</option>
                        <option value="credit">Credit Card</option>
                        <option value="cash">Cash</option>
                        <option value="investment">Investment</option>
                        <option value="loan">Loan</option>
                    </select>

                    <input
                        type="text"
                        value={formData.bankName}
                        onChange={(e) =>
                            setFormData((prev) => ({ ...prev, bankName: e.target.value }))
                        }
                        placeholder="Bank name (optional)"
                        className={`w-full p-2 border rounded ${darkMode
                            ? "bg-gray-700 border-gray-600"
                            : "bg-white border-gray-300"
                            }`}
                    />

                    <div className="relative">
                        <span className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                            $
                        </span>
                        <input
                            type="number"
                            step="0.01"
                            value={formData.balance}
                            onChange={(e) =>
                                setFormData((prev) => ({ ...prev, balance: e.target.value }))
                            }
                            placeholder="Current balance"
                            className={`w-full pl-8 p-2 border rounded ${darkMode
                                ? "bg-gray-700 border-gray-600"
                                : "bg-white border-gray-300"
                                }`}
                        />
                    </div>

                    <div className="flex space-x-2">
                        <button
                            onClick={handleSubmit}
                            className="flex-1 bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700"
                            disabled={!formData.name || formData.balance === ""}
                        >
                            {account ? "Update" : "Add"} Account
                        </button>
                        <button
                            onClick={onCancel}
                            className={`py-2 px-4 rounded border ${darkMode ? "border-gray-600" : "border-gray-300"
                                }`}
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            );
        };

        // Main Component
        const BiweeklyBudgetCalculator = () => {
            const [darkMode, setDarkMode] = useLocalStorage(
                "budgetCalc_darkMode",
                true
            );
            const [takeHomePay, setTakeHomePay] = useLocalStorage(
                "budgetCalc_takeHomePay",
                2800
            );
            const [roundingOption, setRoundingOption] = useLocalStorage(
                "budgetCalc_roundingOption",
                5
            );
            const [bufferPercentage, setBufferPercentage] = useLocalStorage(
                "budgetCalc_bufferPercentage",
                7
            );
            const [whatIfMode, setWhatIfMode] = useState(false);
            const [whatIfPay, setWhatIfPay] = useState(2800);
            const [viewMode, setViewMode] = useLocalStorage(
                "budgetCalc_viewMode",
                "amount"
            );

            const [categories, setCategories] = useLocalStorage(
                "budgetCalc_categories",
                [
                    {
                        id: 1,
                        name: "Personal Care",
                        color: "bg-gradient-to-r from-purple-500 to-pink-500",
                        collapsed: false,
                    },
                    {
                        id: 2,
                        name: "Pet Care",
                        color: "bg-gradient-to-r from-green-500 to-blue-500",
                        collapsed: false,
                    },
                    {
                        id: 3,
                        name: "Savings Goals",
                        color: "bg-gradient-to-r from-purple-600 to-indigo-600",
                        collapsed: false,
                    },
                ]
            );

            const [expenses, setExpenses] = useLocalStorage("budgetCalc_expenses", [
                {
                    id: 1,
                    name: "Hair coloring",
                    amount: 180,
                    frequency: "every-6-weeks",
                    categoryId: 1,
                    priority: "important",
                    alreadySaved: 0,
                    dueDate: "",
                    allocationPaused: false,
                    collapsed: true,
                    isRecurringExpense: false,
                },
                {
                    id: 2,
                    name: "Dog medications",
                    amount: 85,
                    frequency: "every-8-weeks",
                    categoryId: 2,
                    priority: "essential",
                    alreadySaved: 0,
                    dueDate: "",
                    allocationPaused: false,
                    collapsed: true,
                },
            ]);

            const [savingsGoals, setSavingsGoals] = useLocalStorage(
                "budgetCalc_savingsGoals",
                [
                    {
                        id: 1,
                        name: "Emergency fund",
                        targetAmount: 10000,
                        monthlyContribution: 500,
                        targetDate: "2025-12-31",
                        categoryId: 3,
                        alreadySaved: 0,
                        allocationPaused: false,
                        collapsed: true,
                    },
                ]
            );

            const [accounts, setAccounts] = useLocalStorage("budgetCalc_accounts", [
                {
                    id: 1,
                    name: "Main Checking",
                    type: "checking",
                    balance: 3500,
                    bankName: "Chase",
                },
                {
                    id: 2,
                    name: "Savings",
                    type: "savings",
                    balance: 8200,
                    bankName: "Chase",
                },
                {
                    id: 3,
                    name: "Credit Card",
                    type: "credit",
                    balance: -450,
                    bankName: "Capital One",
                },
            ]);

            const [transactions, setTransactions] = useLocalStorage(
                "budgetCalc_transactions",
                [
                    {
                        id: 1,
                        date: "2025-06-01",
                        payee: "Grocery Store",
                        amount: 85.43,
                        categoryId: 1,
                        accountId: 1,
                        memo: "Weekly groceries",
                        cleared: true,
                        transfer: false,
                        transferAccountId: null,
                    },
                    {
                        id: 2,
                        date: "2025-06-01",
                        payee: "",
                        amount: 200,
                        categoryId: null,
                        accountId: 1,
                        memo: "Emergency fund deposit",
                        cleared: true,
                        transfer: true,
                        transferAccountId: 2,
                    },
                ]
            );
            //State Variables
            const [showAddExpense, setShowAddExpense] = useState(false);
            const [showAddCategory, setShowAddCategory] = useState(false);
            const [showAddTransaction, setShowAddTransaction] = useState(false);
            const [showTransactions, setShowTransactions] = useState(false);
            const [showConfig, setShowConfig] = useState(false);
            const [editingCategory, setEditingCategory] = useState(null);
            const [editingExpense, setEditingExpense] = useState(null);
            const [editingTransaction, setEditingTransaction] = useState(null);
            const [confirmDelete, setConfirmDelete] = useState(null);
            const [preselectedCategory, setPreselectedCategory] = useState(null);
            const [selectedAccount, setSelectedAccount] = useState("all");
            const [showAddAccount, setShowAddAccount] = useState(false);
            const [editingAccount, setEditingAccount] = useState(null);
            const [showAddGoal, setShowAddGoal] = useState(false);
            const [editingGoal, setEditingGoal] = useState(null);
            const [showCalendar, setShowCalendar] = useState(false);
            const [paySchedule, setPaySchedule] = useState({
                startDate: "2025-06-13",
                frequency: "bi-weekly",
                splitPaycheck: false,
                primaryAmount: 2200,
                secondaryAmount: 600,
                secondaryDaysEarly: 2,
                primaryAccountId: 1,
                secondaryAccountId: 2,
            });

            const frequencyOptions = [
                { value: "weekly", label: "Weekly", weeksPerYear: 52 },
                { value: "bi-weekly", label: "Bi-weekly", weeksPerYear: 26 },
                {
                    value: "every-3-weeks",
                    label: "Every 3 weeks",
                    weeksPerYear: 17.33,
                },
                { value: "monthly", label: "Monthly", weeksPerYear: 12 },
                {
                    value: "every-6-weeks",
                    label: "Every 6 weeks",
                    weeksPerYear: 8.67,
                },
                {
                    value: "every-7-weeks",
                    label: "Every 7 weeks",
                    weeksPerYear: 7.43,
                },
                { value: "every-8-weeks", label: "Every 8 weeks", weeksPerYear: 6.5 },
                { value: "quarterly", label: "Quarterly", weeksPerYear: 4 },
                { value: "annually", label: "Annually", weeksPerYear: 1 },
                {
                    value: "per-paycheck",
                    label: "Per Paycheck (Direct)",
                    weeksPerYear: 26,
                },
            ];

            const priorityColors = {
                essential: "border-red-400 bg-red-100 text-red-900",
                important: "border-yellow-400 bg-yellow-100 text-yellow-900",
                "nice-to-have": "border-green-400 bg-green-100 text-green-900",
            };

            const categoryColors = [
                "bg-gradient-to-r from-purple-500 to-pink-500",
                "bg-gradient-to-r from-pink-500 to-blue-500",
                "bg-gradient-to-r from-orange-500 to-red-600",
                "bg-gradient-to-r from-green-500 to-yellow-400",
                "bg-gradient-to-r from-pink-500 to-red-500",
                "bg-gradient-to-r from-yellow-400 to-orange-500",
                "bg-gradient-to-r from-purple-600 to-teal-500",
                "bg-gradient-to-r from-violet-600 to-purple-800",
            ];

            const currentPay = whatIfMode ? whatIfPay : takeHomePay;

            // Apply dark mode to document
            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add("dark");
                } else {
                    document.documentElement.classList.remove("dark");
                }
            }, [darkMode]);

            const calculateBiweeklyAllocation = (expense) => {
                if (
                    expense.priorityState === "paused" ||
                    expense.priorityState === "complete"
                )
                    return 0;
                const { amount, frequency, alreadySaved = 0 } = expense;
                const remainingAmount = Math.max(0, amount - alreadySaved);

                if (remainingAmount <= 0) return 0;

                if (frequency === "per-paycheck") {
                    if (roundingOption === 0) return remainingAmount;
                    return Math.ceil(remainingAmount / roundingOption) * roundingOption;
                }

                const freqData = frequencyOptions.find((f) => f.value === frequency);
                if (!freqData) return 0;

                const yearlyAmount = amount * freqData.weeksPerYear;
                const biweeklyAmount = yearlyAmount / 26;
                const adjustedBiweeklyAmount =
                    (remainingAmount / amount) * biweeklyAmount;

                if (roundingOption === 0) return adjustedBiweeklyAmount;
                return (
                    Math.ceil(adjustedBiweeklyAmount / roundingOption) * roundingOption
                );
            };

            const calculateGoalBiweeklyAllocation = (goal) => {
                if (
                    goal.priorityState === "paused" ||
                    goal.priorityState === "complete"
                )
                    return 0;
                const { targetAmount, monthlyContribution, alreadySaved = 0 } = goal;
                const remainingAmount = Math.max(0, targetAmount - alreadySaved);

                if (remainingAmount <= 0) return 0;

                const monthlyAmount = monthlyContribution;
                const biweeklyAmount = (monthlyAmount * 12) / 26;

                if (roundingOption === 0) return biweeklyAmount;
                return Math.ceil(biweeklyAmount / roundingOption) * roundingOption;
            };
            const calculations = useMemo(() => {
                const expenseAllocations = expenses.map((expense) => {
                    const biweeklyAmount = calculateBiweeklyAllocation(expense);
                    const remainingNeeded = Math.max(
                        0,
                        expense.amount - (expense.alreadySaved || 0)
                    );
                    const fundingProgress =
                        expense.amount > 0
                            ? ((expense.alreadySaved || 0) / expense.amount) * 100
                            : 0;
                    const isFullyFunded = fundingProgress >= 100;

                    return {
                        ...expense,
                        biweeklyAmount,
                        percentage: (biweeklyAmount / currentPay) * 100,
                        remainingNeeded,
                        fundingProgress,
                        isFullyFunded,
                    };
                });

                const goalAllocations = savingsGoals.map((goal) => {
                    const biweeklyAmount = calculateGoalBiweeklyAllocation(goal);
                    const remainingNeeded = Math.max(
                        0,
                        goal.targetAmount - (goal.alreadySaved || 0)
                    );
                    const fundingProgress =
                        goal.targetAmount > 0
                            ? ((goal.alreadySaved || 0) / goal.targetAmount) * 100
                            : 0;
                    const isFullyFunded = fundingProgress >= 100;

                    return {
                        ...goal,
                        biweeklyAmount,
                        percentage: (biweeklyAmount / currentPay) * 100,
                        remainingNeeded,
                        fundingProgress,
                        isFullyFunded,
                    };
                });

                const totalExpenseAllocation = expenseAllocations.reduce(
                    (sum, exp) => sum + exp.biweeklyAmount,
                    0
                );
                const totalGoalAllocation = goalAllocations.reduce(
                    (sum, goal) => sum + goal.biweeklyAmount,
                    0
                );
                const totalBiweeklyAllocation =
                    totalExpenseAllocation + totalGoalAllocation;

                const bufferAmount =
                    totalBiweeklyAllocation * (bufferPercentage / 100);
                const totalWithBuffer = totalBiweeklyAllocation + bufferAmount;
                const remainingIncome = currentPay - totalWithBuffer;
                const allocationPercentage = (totalWithBuffer / currentPay) * 100;

                return {
                    expenseAllocations,
                    goalAllocations,
                    totalExpenseAllocation,
                    totalGoalAllocation,
                    totalBiweeklyAllocation,
                    bufferAmount,
                    totalWithBuffer,
                    remainingIncome,
                    allocationPercentage,
                };
            }, [
                expenses,
                savingsGoals,
                currentPay,
                roundingOption,
                bufferPercentage,
            ]);

            const categorizedExpenses = useMemo(() => {
                return categories.map((category) => ({
                    ...category,
                    expenses: calculations.expenseAllocations.filter(
                        (exp) => exp.categoryId === category.id
                    ),
                    goals: calculations.goalAllocations.filter(
                        (goal) => goal.categoryId === category.id
                    ),
                    total:
                        calculations.expenseAllocations
                            .filter((exp) => exp.categoryId === category.id)
                            .reduce((sum, exp) => sum + exp.biweeklyAmount, 0) +
                        calculations.goalAllocations
                            .filter((goal) => goal.categoryId === category.id)
                            .reduce((sum, goal) => sum + goal.biweeklyAmount, 0),
                    percentage:
                        ((calculations.expenseAllocations
                            .filter((exp) => exp.categoryId === category.id)
                            .reduce((sum, exp) => sum + exp.biweeklyAmount, 0) +
                            calculations.goalAllocations
                                .filter((goal) => goal.categoryId === category.id)
                                .reduce((sum, goal) => sum + goal.biweeklyAmount, 0)) /
                            currentPay) *
                        100,
                }));
            }, [
                categories,
                calculations.expenseAllocations,
                calculations.goalAllocations,
                currentPay,
            ]);

            const deleteTransaction = (transactionId) => {
                setTransactions(
                    transactions.filter((txn) => txn.id !== transactionId)
                );
                setConfirmDelete(null);
            };

            const deleteExpense = (expenseId) => {
                setExpenses(expenses.filter((exp) => exp.id !== expenseId));
                setConfirmDelete(null);
            };
            const deleteAccount = (accountId) => {
                setAccounts(accounts.filter((acc) => acc.id !== accountId));
                setTransactions(
                    transactions.filter(
                        (txn) =>
                            txn.accountId !== accountId &&
                            txn.transferAccountId !== accountId
                    )
                );
                setConfirmDelete(null);
            };
            const deleteCategory = (categoryId) => {
                const remainingCategories = categories.filter(
                    (cat) => cat.id !== categoryId
                );
                const firstCategoryId = remainingCategories[0]?.id;

                if (firstCategoryId) {
                    setExpenses(
                        expenses.map((exp) =>
                            exp.categoryId === categoryId
                                ? { ...exp, categoryId: firstCategoryId }
                                : exp
                        )
                    );
                    setSavingsGoals(
                        savingsGoals.map((goal) =>
                            goal.categoryId === categoryId
                                ? { ...goal, categoryId: firstCategoryId }
                                : goal
                        )
                    );
                }

                setCategories(categories.filter((cat) => cat.id !== categoryId));
                setConfirmDelete(null);
            };

            const exportToYNAB = () => {
                const exportData = categorizedExpenses.map((category) => ({
                    category: category.name,
                    biweeklyTotal: category.total,
                    percentage: category.percentage,
                    items: [
                        ...category.expenses.map(
                            (exp) =>
                                `${exp.name}: ${viewMode === "amount"
                                    ? `${exp.biweeklyAmount.toFixed(2)}`
                                    : `${exp.percentage.toFixed(1)}%`
                                }/paycheck (${exp.amount} ${frequencyOptions
                                    .find((f) => f.value === exp.frequency)
                                    ?.label.toLowerCase()})${exp.allocationPaused ? " [PAUSED]" : ""
                                }${exp.isFullyFunded ? " [FUNDED]" : ""}`
                        ),
                        ...category.goals.map(
                            (goal) =>
                                `${goal.name} (Goal): ${viewMode === "amount"
                                    ? `${goal.biweeklyAmount.toFixed(2)}`
                                    : `${goal.percentage.toFixed(1)}%`
                                }/paycheck${goal.allocationPaused ? " [PAUSED]" : ""}${goal.isFullyFunded ? " [COMPLETE]" : ""
                                }`
                        ),
                    ],
                }));

                const exportText =
                    `BI-WEEKLY BUDGET BREAKDOWN\n` +
                    `Take-home pay: ${currentPay.toFixed(2)}\n` +
                    `Total allocations: ${calculations.totalBiweeklyAllocation.toFixed(
                        2
                    )} (${(
                        (calculations.totalBiweeklyAllocation / currentPay) *
                        100
                    ).toFixed(1)}%)\n` +
                    `Buffer (${bufferPercentage}%): ${calculations.bufferAmount.toFixed(
                        2
                    )}\n` +
                    `Total with buffer: ${calculations.totalWithBuffer.toFixed(
                        2
                    )} (${calculations.allocationPercentage.toFixed(1)}%)\n` +
                    `Remaining: ${calculations.remainingIncome.toFixed(2)} (${(
                        (calculations.remainingIncome / currentPay) *
                        100
                    ).toFixed(1)}%)\n\n` +
                    exportData
                        .map(
                            (cat) =>
                                `${cat.category.toUpperCase()} - ${cat.biweeklyTotal.toFixed(
                                    2
                                )}/paycheck (${cat.percentage.toFixed(1)}%)\n${cat.items
                                    .map((item) => `• ${item}`)
                                    .join("\n")}`
                        )
                        .join("\n\n");

                // Copy to clipboard or show in alert
                if (navigator.clipboard) {
                    navigator.clipboard
                        .writeText(exportText)
                        .then(() => {
                            alert("Budget data copied to clipboard!");
                        })
                        .catch(() => {
                            prompt("Copy this text for YNAB:", exportText);
                        });
                } else {
                    prompt("Copy this text for YNAB:", exportText);
                }
            };

            return (
                <div
                    className={`min-h-screen transition-colors duration-200 ${darkMode ? "bg-gray-900 text-white" : "bg-gray-50 text-gray-900"
                        }`}
                >
                    <div className="container mx-auto px-4 py-8 max-w-6xl">
                        {/* Header */}
                        <div className="flex justify-between items-center mb-8">
                            <div>
                                <h1 className="text-3xl font-bold mb-2">
                                    Bi-weekly Budget Calculator
                                </h1>
                                <p
                                    className={`${darkMode ? "text-gray-400" : "text-gray-600"
                                        }`}
                                >
                                    Plan your YNAB allocations with precision
                                </p>
                            </div>
                            <div className="flex space-x-2">
                                <button
                                    onClick={() =>
                                        setViewMode(
                                            viewMode === "amount" ? "percentage" : "amount"
                                        )
                                    }
                                    className={`p-2 rounded-lg flex items-center space-x-2 ${viewMode === "percentage"
                                        ? "bg-green-600 text-white"
                                        : `${darkMode
                                            ? "bg-gray-800 hover:bg-gray-700"
                                            : "bg-white hover:bg-gray-100"
                                        }`
                                        } transition-colors`}
                                >
                                    <Percent />
                                    <span className="text-sm hidden sm:inline">
                                        {viewMode === "amount" ? "Show %" : "Show $"}
                                    </span>
                                </button>
                                <button
                                    onClick={() => setShowCalendar(true)}
                                    className={`p-2 rounded-lg ${darkMode
                                        ? "bg-gray-700 hover:bg-gray-600"
                                        : "bg-gray-100 hover:bg-gray-200"
                                        } transition-colors`}
                                    title="Open calendar view"
                                >
                                    📅
                                </button>
                                <button
                                    onClick={() => {
                                        setWhatIfMode(!whatIfMode);
                                        if (!whatIfMode) setWhatIfPay(takeHomePay);
                                    }}
                                    className={`p-2 rounded-lg flex items-center space-x-2 ${whatIfMode
                                        ? "bg-blue-600 text-white"
                                        : `${darkMode
                                            ? "bg-gray-800 hover:bg-gray-700"
                                            : "bg-white hover:bg-gray-100"
                                        }`
                                        } transition-colors`}
                                >
                                    <Eye />
                                    <span className="text-sm hidden sm:inline">What-If</span>
                                </button>
                                <button
                                    onClick={() => setDarkMode(!darkMode)}
                                    className={`p-2 rounded-lg ${darkMode
                                        ? "bg-gray-800 hover:bg-gray-700"
                                        : "bg-white hover:bg-gray-100"
                                        } transition-colors`}
                                >
                                    {darkMode ? <Sun /> : <Moon />}
                                </button>
                            </div>
                        </div>

                        {/* Configuration Panel */}
                        <div
                            className={`${darkMode ? "bg-gray-800" : "bg-white"
                                } rounded-lg p-6 mb-8 shadow-lg`}
                        >
                            <div className="flex justify-between items-center mb-4">
                                <div
                                    className="flex items-center cursor-pointer flex-1"
                                    onClick={() => setShowConfig(!showConfig)}
                                >
                                    {showConfig ? (
                                        <ChevronDown className="w-5 h-5 mr-2" />
                                    ) : (
                                        <ChevronRight className="w-5 h-5 mr-2" />
                                    )}
                                    <h2 className="text-xl font-semibold flex items-center">
                                        <Calculator />
                                        <span className="ml-2">Configuration</span>
                                        {whatIfMode && (
                                            <span className="ml-2 text-sm bg-blue-600 text-white px-2 py-1 rounded">
                                                What-If Mode
                                            </span>
                                        )}
                                        {viewMode === "percentage" && (
                                            <span className="ml-2 text-sm bg-green-600 text-white px-2 py-1 rounded">
                                                % View
                                            </span>
                                        )}
                                    </h2>
                                </div>
                                <div className="flex space-x-2">
                                    <button
                                        onClick={exportToYNAB}
                                        className={`p-2 rounded-lg ${darkMode
                                            ? "bg-gray-700 hover:bg-gray-600"
                                            : "bg-gray-100 hover:bg-gray-200"
                                            } transition-colors`}
                                        title="Export to YNAB"
                                    >
                                        <Download />
                                    </button>
                                </div>
                            </div>

                            {showConfig && (
                                <div className="space-y-4">
                                    {/* Split paycheck section - always show checkbox */}
                                    <div
                                        className={`p-4 rounded border ${darkMode
                                            ? "border-gray-600 bg-gray-700"
                                            : "border-gray-300 bg-gray-50"
                                            }`}
                                    >
                                        <div className="flex items-center mb-4">
                                            <input
                                                type="checkbox"
                                                id="splitPaycheck"
                                                checked={paySchedule.splitPaycheck}
                                                onChange={(e) =>
                                                    setPaySchedule((prev) => ({
                                                        ...prev,
                                                        splitPaycheck: e.target.checked,
                                                    }))
                                                }
                                                className="mr-2"
                                            />
                                            <label
                                                htmlFor="splitPaycheck"
                                                className="text-sm font-medium"
                                            >
                                                I receive split paychecks (direct deposit to multiple
                                                accounts)
                                            </label>
                                            {paySchedule.splitPaycheck && accounts.length >= 2 && (
                                                <span className="ml-2 text-xs bg-purple-500 text-white px-2 py-1 rounded">
                                                    Split Pay
                                                </span>
                                            )}
                                        </div>

                                        {/* Show helper text only when checkbox is checked but <2 accounts */}
                                        {paySchedule.splitPaycheck && accounts.length < 2 && (
                                            <div
                                                className={`p-3 rounded border ${darkMode
                                                    ? "border-yellow-600 bg-yellow-900/20"
                                                    : "border-yellow-300 bg-yellow-50"
                                                    } mb-4`}
                                            >
                                                <div className="flex items-center text-sm">
                                                    <span className="mr-2">💡</span>
                                                    <span>
                                                        You'll need a second account to split your
                                                        paycheck.
                                                    </span>
                                                    <button
                                                        onClick={() => setShowAddAccount(true)}
                                                        className={`ml-2 hover:underline ${darkMode ? "text-blue-400" : "text-blue-600"
                                                            }`}
                                                    >
                                                        Add Account
                                                    </button>
                                                </div>
                                            </div>
                                        )}

                                        {/* Show split paycheck form only when checkbox is checked AND 2+ accounts */}
                                        {paySchedule.splitPaycheck && accounts.length >= 2 && (
                                            <div className="space-y-4">
                                                {/* ... your existing split paycheck form content ... */}
                                            </div>
                                        )}
                                    </div>

                                    {/* Main config row - responsive stacking */}
                                    <div className="grid grid-cols-1 lg:grid-cols-4 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">
                                                {whatIfMode ? "What-If Pay" : "Take-home Pay"}{" "}
                                                (bi-weekly)
                                            </label>
                                            <div className="relative">
                                                <span className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                                                    $
                                                </span>
                                                <input
                                                    type="number"
                                                    value={whatIfMode ? whatIfPay : takeHomePay}
                                                    onChange={(e) =>
                                                        whatIfMode
                                                            ? setWhatIfPay(parseFloat(e.target.value) || 0)
                                                            : setTakeHomePay(
                                                                parseFloat(e.target.value) || 0
                                                            )
                                                    }
                                                    className={`w-full pl-8 p-2 border rounded ${darkMode
                                                        ? "bg-gray-700 border-gray-600"
                                                        : "bg-white border-gray-300"
                                                        } ${whatIfMode ? "ring-2 ring-blue-500" : ""}`}
                                                />
                                            </div>
                                            {!paySchedule.splitPaycheck && (
                                                <div className="text-xs text-gray-500 mt-1">
                                                    Complete bi-weekly amount
                                                </div>
                                            )}
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium mb-1">
                                                Rounding
                                            </label>
                                            <select
                                                value={roundingOption}
                                                onChange={(e) =>
                                                    setRoundingOption(parseInt(e.target.value))
                                                }
                                                className={`w-full p-2 border rounded ${darkMode
                                                    ? "bg-gray-700 border-gray-600"
                                                    : "bg-white border-gray-300"
                                                    }`}
                                            >
                                                <option value={0}>No rounding</option>
                                                <option value={5}>Round to $5</option>
                                                <option value={10}>Round to $10</option>
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium mb-1">
                                                Buffer (%)
                                            </label>
                                            <input
                                                type="number"
                                                min="0"
                                                max="20"
                                                value={bufferPercentage}
                                                onChange={(e) =>
                                                    setBufferPercentage(parseFloat(e.target.value) || 0)
                                                }
                                                className={`w-full p-2 border rounded ${darkMode
                                                    ? "bg-gray-700 border-gray-600"
                                                    : "bg-white border-gray-300"
                                                    }`}
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium mb-1">
                                                Next Paycheck Date
                                            </label>
                                            <input
                                                type="date"
                                                value={paySchedule.startDate}
                                                onChange={(e) =>
                                                    setPaySchedule((prev) => ({
                                                        ...prev,
                                                        startDate: e.target.value,
                                                    }))
                                                }
                                                className={`w-full p-2 border rounded ${darkMode
                                                    ? "bg-gray-700 border-gray-600"
                                                    : "bg-white border-gray-300"
                                                    }`}
                                                style={darkMode ? { colorScheme: "dark" } : {}}
                                            />
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Summary Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                            <div
                                className={`${darkMode ? "bg-gray-800" : "bg-white"
                                    } rounded-lg p-4 shadow-lg`}
                            >
                                <h3 className="text-sm font-medium text-gray-500 mb-1">
                                    Total Allocation
                                </h3>
                                <p className="text-2xl font-bold text-blue-400">
                                    {viewMode === "amount"
                                        ? `$${calculations.totalBiweeklyAllocation.toFixed(2)}`
                                        : `${(
                                            (calculations.totalBiweeklyAllocation / currentPay) *
                                            100
                                        ).toFixed(1)}%`}
                                </p>
                            </div>

                            <div
                                className={`${darkMode ? "bg-gray-800" : "bg-white"
                                    } rounded-lg p-4 shadow-lg`}
                            >
                                <h3 className="text-sm font-medium text-gray-500 mb-1">
                                    Buffer Amount
                                </h3>
                                <p className="text-2xl font-bold text-purple-400">
                                    {viewMode === "amount"
                                        ? `$${calculations.bufferAmount.toFixed(2)}`
                                        : `${bufferPercentage}%`}
                                </p>
                            </div>

                            <div
                                className={`${darkMode ? "bg-gray-800" : "bg-white"
                                    } rounded-lg p-4 shadow-lg`}
                            >
                                <h3 className="text-sm font-medium text-gray-500 mb-1">
                                    Total with Buffer
                                </h3>
                                <p className="text-2xl font-bold text-pink-400">
                                    {viewMode === "amount"
                                        ? `$${calculations.totalWithBuffer.toFixed(2)}`
                                        : `${calculations.allocationPercentage.toFixed(1)}%`}
                                </p>
                            </div>

                            <div
                                className={`${darkMode ? "bg-gray-800" : "bg-white"
                                    } rounded-lg p-4 shadow-lg`}
                            >
                                <h3 className="text-sm font-medium text-gray-500 mb-1">
                                    Remaining Income
                                </h3>
                                <p
                                    className={`text-2xl font-bold ${calculations.remainingIncome >= 0
                                        ? "text-green-400"
                                        : "text-red-400"
                                        }`}
                                >
                                    {viewMode === "amount"
                                        ? `$${calculations.remainingIncome.toFixed(2)}`
                                        : `${(
                                            (calculations.remainingIncome / currentPay) *
                                            100
                                        ).toFixed(1)}%`}
                                </p>
                            </div>
                        </div>
                        {/* Accounts Section */}
                        <div
                            className={`${darkMode ? "bg-gray-800" : "bg-white"
                                } rounded-lg p-6 mb-8 shadow-lg`}
                        >
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-xl font-semibold flex items-center">
                                    🏦 <span className="ml-2">Accounts</span>
                                </h2>
                                <button
                                    onClick={() => setShowAddAccount(true)}
                                    className="bg-purple-600 text-white px-3 py-2 rounded text-sm hover:bg-purple-700 flex items-center"
                                >
                                    <Plus className="w-4 h-4 mr-1" />
                                    Add Account
                                </button>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {accounts.map((account) => (
                                    <div
                                        key={account.id}
                                        className={`p-4 rounded border ${darkMode
                                            ? "border-gray-600 bg-gray-700"
                                            : "border-gray-200 bg-gray-50"
                                            }`}
                                    >
                                        <div className="flex items-center justify-between">
                                            <div className="flex-1">
                                                <div className="font-medium">{account.name}</div>
                                                <div className="text-sm text-gray-500 capitalize">
                                                    {account.type} • {account.bankName}
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div
                                                    className={`font-semibold ${account.type === "credit"
                                                        ? account.balance < 0
                                                            ? "text-red-400"
                                                            : "text-green-400"
                                                        : account.balance >= 0
                                                            ? "text-green-400"
                                                            : "text-red-400"
                                                        }`}
                                                >
                                                    ${Math.abs(account.balance).toFixed(2)}
                                                </div>
                                                <div className="text-xs text-gray-500">
                                                    {account.type === "credit"
                                                        ? account.balance < 0
                                                            ? "owed"
                                                            : "credit"
                                                        : "balance"}
                                                </div>
                                            </div>
                                            <div className="flex space-x-1 ml-2">
                                                <button
                                                    onClick={() => setEditingAccount(account)}
                                                    className="p-1 hover:bg-gray-600 rounded"
                                                >
                                                    <Edit2 className="w-3 h-3" />
                                                </button>
                                                <button
                                                    onClick={() =>
                                                        setConfirmDelete({
                                                            type: "account",
                                                            id: account.id,
                                                            name: account.name,
                                                            message: `Delete "${account.name}"? All associated transactions will also be deleted.`,
                                                        })
                                                    }
                                                    className="p-1 hover:bg-gray-600 rounded text-red-400"
                                                >
                                                    <Trash2 className="w-3 h-3" />
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Categories and Expenses */}
                        <div className="grid grid-cols-1 xl:grid-cols-3 gap-8">
                            <div className="xl:col-span-2">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-semibold">
                                        Budget Items by Category
                                    </h2>
                                    <div className="flex space-x-2">
                                        <button
                                            onClick={() => setShowAddCategory(true)}
                                            className="bg-purple-600 text-white px-2 sm:px-3 py-1 rounded text-sm hover:bg-purple-700 flex items-center"
                                        >
                                            <Plus className="w-4 h-4 mr-1" />
                                            <span className="hidden sm:inline">Category</span>
                                        </button>
                                        <button
                                            onClick={() => setShowAddExpense(true)}
                                            className="bg-blue-600 text-white px-2 sm:px-3 py-1 rounded text-sm hover:bg-blue-700 flex items-center"
                                        >
                                            <Plus className="w-4 h-4 mr-1" />
                                            <span className="hidden sm:inline">Expense</span>
                                        </button>
                                        <button
                                            onClick={() => {
                                                setPreselectedCategory(3); // 3 is the ID of "Savings Goals" category
                                                setShowAddGoal(true);
                                            }}
                                            className="bg-green-600 text-white px-2 sm:px-3 py-1 rounded text-sm hover:bg-green-700 flex items-center"
                                        >
                                            <Target className="w-4 h-4 mr-1" />
                                            <span className="hidden sm:inline">Goal</span>
                                        </button>
                                    </div>
                                </div>

                                <div className="space-y-4">
                                    {categorizedExpenses.map((category) => (
                                        <div
                                            key={category.id}
                                            className={`${darkMode ? "bg-gray-800" : "bg-white"
                                                } rounded-lg shadow-lg overflow-hidden`}
                                        >
                                            <div className="p-4 relative">
                                                <div
                                                    className={`absolute left-0 top-0 bottom-0 w-2 ${category.color}`}
                                                ></div>
                                                <div className="flex items-center justify-between mb-3">
                                                    <div
                                                        className="flex items-center cursor-pointer flex-1"
                                                        onClick={() => {
                                                            setCategories((prev) =>
                                                                prev.map((cat) =>
                                                                    cat.id === category.id
                                                                        ? { ...cat, collapsed: !cat.collapsed }
                                                                        : cat
                                                                )
                                                            );
                                                        }}
                                                    >
                                                        {category.collapsed ? (
                                                            <ChevronRight className="w-4 h-4 mr-2" />
                                                        ) : (
                                                            <ChevronDown className="w-4 h-4 mr-2" />
                                                        )}
                                                        <div
                                                            className={`w-6 h-6 rounded-full ${category.color} mr-3 shadow-lg border-2 border-white dark:border-white`}
                                                        ></div>
                                                        <h3 className="font-semibold">{category.name}</h3>
                                                        <span className="ml-2 text-sm text-gray-500">
                                                            {viewMode === "amount"
                                                                ? `$${category.total.toFixed(2)}/bi-weekly`
                                                                : `${category.percentage.toFixed(1)}%`}
                                                        </span>
                                                    </div>
                                                    <div className="flex space-x-1">
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                setPreselectedCategory(category.id);
                                                                setShowAddExpense(true);
                                                            }}
                                                            className="p-1 hover:bg-gray-700 rounded text-blue-400 hover:text-blue-300"
                                                            title="Add expense to this category"
                                                        >
                                                            <Plus className="w-4 h-4" />
                                                        </button>
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                setEditingCategory(category);
                                                            }}
                                                            className="p-1 hover:bg-gray-700 rounded"
                                                        >
                                                            <Edit2 className="w-4 h-4" />
                                                        </button>
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                setConfirmDelete({
                                                                    type: "category",
                                                                    id: category.id,
                                                                    name: category.name,
                                                                    message:
                                                                        "Delete this category? All items will be moved to the first category.",
                                                                });
                                                            }}
                                                            className="p-1 hover:bg-gray-700 rounded text-red-400"
                                                        >
                                                            <Trash2 className="w-4 h-4" />
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            {!category.collapsed && (
                                                <div className="space-y-2">
                                                    {category.expenses.length === 0 &&
                                                        category.goals.length === 0 ? (
                                                        <p className="text-gray-500 text-sm italic">
                                                            No items in this category
                                                        </p>
                                                    ) : (
                                                        <div className="space-y-2">
                                                            {category.expenses.map((expense) => (
                                                                <div
                                                                    key={`exp-${expense.id}`}
                                                                    className={`border-l-4 ${priorityColors[expense.priority]
                                                                        } ${expense.isFullyFunded ? "opacity-75" : ""
                                                                        } ${expense.allocationPaused
                                                                            ? "opacity-60"
                                                                            : ""
                                                                        } rounded-r`}
                                                                >
                                                                    <div
                                                                        className="p-3 cursor-pointer transition-colors"
                                                                        onClick={() => {
                                                                            setExpenses((prev) =>
                                                                                prev.map((exp) =>
                                                                                    exp.id === expense.id
                                                                                        ? {
                                                                                            ...exp,
                                                                                            collapsed: !exp.collapsed,
                                                                                        }
                                                                                        : exp
                                                                                )
                                                                            );
                                                                        }}
                                                                    >
                                                                        <div className="flex items-center justify-between">
                                                                            <div className="flex items-center flex-1 min-w-0">
                                                                                {expense.collapsed ? (
                                                                                    <ChevronRight className="w-4 h-4 mr-2 flex-shrink-0" />
                                                                                ) : (
                                                                                    <ChevronDown className="w-4 h-4 mr-2 flex-shrink-0" />
                                                                                )}
                                                                                <div className="flex-1 min-w-0">
                                                                                    <div className="flex items-center">
                                                                                        <span className="font-medium truncate">
                                                                                            {expense.name}
                                                                                        </span>
                                                                                        {expense.priorityState === 'active' && (
                                                                                            <span className="text-xs ml-2" title="Active">🟢</span>
                                                                                        )}
                                                                                        {expense.priorityState === 'paused' && (
                                                                                            <span className="text-xs ml-2" title="Paused">⏸️</span>
                                                                                        )}
                                                                                        {expense.priorityState === 'complete' && (
                                                                                            <span className="text-xs ml-2" title="Funded">✅</span>
                                                                                        )}
                                                                                        <div className="flex items-center ml-2 space-x-1 flex-shrink-0">
                                                                                            {expense.allocationPaused && (
                                                                                                <span className="text-xs bg-gray-500 text-white px-1.5 py-0.5 rounded">
                                                                                                    PAUSED
                                                                                                </span>
                                                                                            )}
                                                                                            {expense.isFullyFunded &&
                                                                                                !expense.allocationPaused && (
                                                                                                    <span className="text-xs bg-green-500 text-white px-1.5 py-0.5 rounded">
                                                                                                        FUNDED
                                                                                                    </span>
                                                                                                )}
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                            <div className="flex items-center space-x-3 flex-shrink-0">
                                                                                <div className="text-right">
                                                                                    <div className="font-semibold">
                                                                                        {viewMode === "amount"
                                                                                            ? `$${expense.biweeklyAmount.toFixed(
                                                                                                2
                                                                                            )}`
                                                                                            : `${expense.percentage.toFixed(
                                                                                                1
                                                                                            )}%`}
                                                                                    </div>
                                                                                    <div className="text-xs text-gray-500">
                                                                                        bi-weekly
                                                                                    </div>
                                                                                </div>
                                                                                <div className="flex space-x-1">
                                                                                    <button
                                                                                        onClick={(e) => {
                                                                                            e.stopPropagation();
                                                                                            setEditingExpense(expense);
                                                                                        }}
                                                                                        className="p-1 hover:bg-gray-700 rounded"
                                                                                    >
                                                                                        <Edit2 className="w-3 h-3" />
                                                                                    </button>
                                                                                    <button
                                                                                        onClick={(e) => {
                                                                                            e.stopPropagation();
                                                                                            setConfirmDelete({
                                                                                                type: "expense",
                                                                                                id: expense.id,
                                                                                                name: expense.name,
                                                                                                message: `Delete "${expense.name}"?`,
                                                                                            });
                                                                                        }}
                                                                                        className="p-1 hover:bg-gray-700 rounded text-red-400"
                                                                                    >
                                                                                        <Trash2 className="w-3 h-3" />
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    {!expense.collapsed && (
                                                                        <div className="px-3 pb-3 bg-gray-50">
                                                                            <div className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                                                                                ${expense.amount}{" "}
                                                                                {frequencyOptions
                                                                                    .find(
                                                                                        (f) =>
                                                                                            f.value === expense.frequency
                                                                                    )
                                                                                    ?.label.toLowerCase()}
                                                                            </div>

                                                                            {expense.remainingNeeded > 0 && (
                                                                                <div className="text-xs text-blue-500">
                                                                                    $
                                                                                    {expense.remainingNeeded.toFixed(2)}{" "}
                                                                                    remaining to save
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ))}

                                                            {category.goals.map((goal) => (
                                                                <div
                                                                    key={`goal-${goal.id}`}
                                                                    className={`border-l-4 border-green-400 bg-green-100 text-green-900 ${goal.isFullyFunded ? "opacity-75" : ""
                                                                        } ${goal.allocationPaused ? "opacity-60" : ""
                                                                        } rounded-r`}
                                                                >
                                                                    <div
                                                                        className="p-3 cursor-pointer transition-colors"
                                                                        onClick={() => {
                                                                            setSavingsGoals((prev) =>
                                                                                prev.map((g) =>
                                                                                    g.id === goal.id
                                                                                        ? {
                                                                                            ...g,
                                                                                            collapsed: !g.collapsed,
                                                                                        }
                                                                                        : g
                                                                                )
                                                                            );
                                                                        }}
                                                                    >
                                                                        <div className="flex items-center justify-between">
                                                                            <div className="flex items-center flex-1 min-w-0">
                                                                                {goal.collapsed ? (
                                                                                    <ChevronRight className="w-4 h-4 mr-2 flex-shrink-0" />
                                                                                ) : (
                                                                                    <ChevronDown className="w-4 h-4 mr-2 flex-shrink-0" />
                                                                                )}
                                                                                <Target className="w-4 h-4 mr-2 flex-shrink-0" />
                                                                                <div className="flex-1 min-w-0">
                                                                                    <div className="flex items-center">
                                                                                        <span className="font-medium truncate">
                                                                                            {goal.name}
                                                                                        </span>
                                                                                        {goal.priorityState === 'active' && (
                                                                                            <span className="text-xs ml-2" title="Active">🟢</span>
                                                                                        )}
                                                                                        {goal.priorityState === 'paused' && (
                                                                                            <span className="text-xs ml-2" title="Paused">⏸️</span>
                                                                                        )}
                                                                                        {goal.priorityState === 'complete' && (
                                                                                            <span className="text-xs ml-2" title="Funded">✅</span>
                                                                                        )}
                                                                                        <span className="text-xs bg-green-600 text-white px-1.5 py-0.5 rounded ml-2">
                                                                                            {goal.fundingProgress.toFixed(0)}%
                                                                                        </span>
                                                                                        <div className="flex items-center ml-2 space-x-1 flex-shrink-0">
                                                                                            {goal.allocationPaused && (
                                                                                                <span className="text-xs bg-gray-500 text-white px-1.5 py-0.5 rounded">
                                                                                                    PAUSED
                                                                                                </span>
                                                                                            )}
                                                                                            {goal.isFullyFunded &&
                                                                                                !goal.allocationPaused && (
                                                                                                    <span className="text-xs bg-green-500 text-white px-1.5 py-0.5 rounded">
                                                                                                        COMPLETE
                                                                                                    </span>
                                                                                                )}
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                            <div className="flex items-center space-x-3 flex-shrink-0">
                                                                                <div className="text-right">
                                                                                    <div className="font-semibold">
                                                                                        {viewMode === "amount"
                                                                                            ? `$${goal.biweeklyAmount.toFixed(
                                                                                                2
                                                                                            )}`
                                                                                            : `${goal.percentage.toFixed(
                                                                                                1
                                                                                            )}%`}
                                                                                    </div>
                                                                                    <div className="text-xs text-gray-500">
                                                                                        bi-weekly
                                                                                    </div>
                                                                                </div>
                                                                                <div className="flex space-x-1">
                                                                                    <button
                                                                                        onClick={(e) => {
                                                                                            e.stopPropagation();
                                                                                            setEditingGoal(goal);
                                                                                        }}
                                                                                        className="p-1 hover:bg-gray-700 rounded"
                                                                                    >
                                                                                        <Edit2 className="w-3 h-3" />
                                                                                    </button>
                                                                                    <button
                                                                                        onClick={(e) => {
                                                                                            e.stopPropagation();
                                                                                            setConfirmDelete({
                                                                                                type: "goal",
                                                                                                id: goal.id,
                                                                                                name: goal.name,
                                                                                                message: `Delete "${goal.name}" savings goal?`,
                                                                                            });
                                                                                        }}
                                                                                        className="p-1 hover:bg-gray-700 rounded text-red-400"
                                                                                    >
                                                                                        <Trash2 className="w-3 h-3" />
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    {!goal.collapsed && (
                                                                        <div className="px-3 pb-3 bg-green-200">
                                                                            <div className="text-sm text-gray-700 dark:text-gray-400 mb-2">
                                                                                Target: $
                                                                                {goal.targetAmount.toLocaleString()}{" "}
                                                                                by {goal.targetDate}
                                                                            </div>

                                                                            <div className="space-y-1">
                                                                                <div className="flex justify-between text-xs">
                                                                                    <span>
                                                                                        Progress: $
                                                                                        {goal.alreadySaved || 0} / $
                                                                                        {goal.targetAmount.toLocaleString()}
                                                                                    </span>
                                                                                    <span>
                                                                                        {goal.fundingProgress.toFixed(0)}%
                                                                                    </span>
                                                                                </div>
                                                                                <div className="w-full bg-gray-200 rounded-full h-2">
                                                                                    <div
                                                                                        className={`h-2 rounded-full ${goal.isFullyFunded
                                                                                            ? "bg-green-500"
                                                                                            : "bg-green-400"
                                                                                            }`}
                                                                                        style={{
                                                                                            width: `${Math.min(
                                                                                                100,
                                                                                                goal.fundingProgress
                                                                                            )}%`,
                                                                                        }}
                                                                                    ></div>
                                                                                </div>

                                                                                {goal.remainingNeeded > 0 && (
                                                                                    <div className="text-xs text-green-700">
                                                                                        $
                                                                                        {goal.remainingNeeded.toLocaleString()}{" "}
                                                                                        remaining to save
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Recent Transactions Section */}
                            <div className="space-y-6">
                                <div
                                    className={`${darkMode ? "bg-gray-800" : "bg-white"
                                        } rounded-lg p-4 shadow-lg`}
                                >
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-lg font-semibold flex items-center">
                                            💳 Recent Transactions
                                        </h3>
                                        <div className="flex space-x-2">
                                            <button
                                                onClick={() => setShowAddTransaction(true)}
                                                className="bg-blue-600 text-white px-2 py-1 rounded text-sm hover:bg-blue-700 flex items-center"
                                            >
                                                <Plus className="w-3 h-3 mr-1" />
                                                Transaction
                                            </button>
                                            <button
                                                onClick={() => setShowTransactions(true)}
                                                className="bg-gray-600 text-white px-2 py-1 rounded text-sm hover:bg-gray-700"
                                            >
                                                View All
                                            </button>
                                        </div>
                                    </div>

                                    <div className="space-y-2">
                                        {transactions
                                            .slice(-5)
                                            .reverse()
                                            .map((transaction) => {
                                                const account = accounts.find(
                                                    (acc) => acc.id === transaction.accountId
                                                );
                                                const category = categories.find(
                                                    (cat) => cat.id === transaction.categoryId
                                                );
                                                const transferAccount = transaction.transferAccountId
                                                    ? accounts.find(
                                                        (acc) =>
                                                            acc.id === transaction.transferAccountId
                                                    )
                                                    : null;

                                                return (
                                                    <div
                                                        key={transaction.id}
                                                        className={`p-3 rounded border ${darkMode
                                                            ? "border-gray-600 bg-gray-700"
                                                            : "border-gray-200 bg-gray-50"
                                                            }`}
                                                    >
                                                        <div className="flex items-center justify-between">
                                                            <div className="flex-1 min-w-0">
                                                                <div className="flex items-center">
                                                                    <span className="font-medium truncate">
                                                                        {transaction.transfer
                                                                            ? `Transfer to ${transferAccount?.name}`
                                                                            : transaction.payee}
                                                                    </span>
                                                                    {transaction.cleared && (
                                                                        <span className="ml-2 text-green-500">
                                                                            ✓
                                                                        </span>
                                                                    )}
                                                                </div>
                                                                <div className="text-sm text-gray-500">
                                                                    {transaction.date} • {account?.name}{" "}
                                                                    {category && `• ${category.name}`}
                                                                </div>
                                                                {transaction.memo && (
                                                                    <div className="text-xs text-gray-400 truncate">
                                                                        {transaction.memo}
                                                                    </div>
                                                                )}
                                                            </div>
                                                            <div className="text-right ml-2">
                                                                <div className="font-semibold">
                                                                    ${transaction.amount.toFixed(2)}
                                                                </div>
                                                                <div className="flex space-x-1">
                                                                    <button
                                                                        onClick={() =>
                                                                            setEditingTransaction(transaction)
                                                                        }
                                                                        className="p-1 hover:bg-gray-600 rounded"
                                                                    >
                                                                        <Edit2 className="w-3 h-3" />
                                                                    </button>
                                                                    <button
                                                                        onClick={() =>
                                                                            setConfirmDelete({
                                                                                type: "transaction",
                                                                                id: transaction.id,
                                                                                name: transaction.transfer
                                                                                    ? `Transfer to ${transferAccount?.name}`
                                                                                    : transaction.payee,
                                                                                message: `Delete this transaction?`,
                                                                            })
                                                                        }
                                                                        className="p-1 hover:bg-gray-600 rounded text-red-400"
                                                                    >
                                                                        <Trash2 className="w-3 h-3" />
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        {transactions.length === 0 && (
                                            <p className="text-gray-500 text-sm italic text-center py-4">
                                                No transactions yet
                                            </p>
                                        )}
                                    </div>
                                </div>

                                {/* Summary Panel */}
                                <div
                                    className={`${darkMode ? "bg-gray-800" : "bg-white"
                                        } rounded-lg p-6 shadow-lg h-fit`}
                                >
                                    <h3 className="text-lg font-semibold mb-4 flex items-center">
                                        📊 Quick Summary
                                    </h3>

                                    <div className="space-y-3 text-sm">
                                        <div className="flex justify-between items-center">
                                            <span className="flex items-center">💰 Paycheck:</span>
                                            <span className="font-medium">
                                                ${currentPay.toFixed(2)}
                                            </span>
                                        </div>

                                        <div className="flex justify-between">
                                            <span>Allocations:</span>
                                            <span className="font-medium">
                                                {viewMode === "amount"
                                                    ? `$${calculations.totalBiweeklyAllocation.toFixed(
                                                        2
                                                    )}`
                                                    : `${(
                                                        (calculations.totalBiweeklyAllocation /
                                                            currentPay) *
                                                        100
                                                    ).toFixed(1)}%`}
                                            </span>
                                        </div>

                                        <div className="flex justify-between">
                                            <span>Buffer ({bufferPercentage}%):</span>
                                            <span className="font-medium">
                                                {viewMode === "amount"
                                                    ? `$${calculations.bufferAmount.toFixed(2)}`
                                                    : `${bufferPercentage}%`}
                                            </span>
                                        </div>

                                        <hr
                                            className={`${darkMode ? "border-gray-700" : "border-gray-200"
                                                }`}
                                        />

                                        <div className="flex justify-between font-semibold">
                                            <span>Total Needed:</span>
                                            <span>
                                                {viewMode === "amount"
                                                    ? `$${calculations.totalWithBuffer.toFixed(2)}`
                                                    : `${calculations.allocationPercentage.toFixed(
                                                        1
                                                    )}%`}
                                            </span>
                                        </div>

                                        <div
                                            className={`flex justify-between font-semibold ${calculations.remainingIncome >= 0
                                                ? "text-green-400"
                                                : "text-red-400"
                                                }`}
                                        >
                                            <span>Remaining:</span>
                                            <span>
                                                {viewMode === "amount"
                                                    ? `$${calculations.remainingIncome.toFixed(2)}`
                                                    : `${(
                                                        (calculations.remainingIncome / currentPay) *
                                                        100
                                                    ).toFixed(1)}%`}
                                            </span>
                                        </div>
                                    </div>

                                    {whatIfMode && (
                                        <div className="mt-6 p-3 bg-blue-100 dark:bg-blue-900/20 rounded">
                                            <h4 className="font-medium text-blue-900 dark:text-blue-100 mb-2 flex items-center">
                                                🔮 What-If Analysis
                                            </h4>
                                            <div className="text-sm text-blue-800 dark:text-blue-200">
                                                <div>💰 Current: ${takeHomePay.toFixed(2)}</div>
                                                <div>🔍 What-If: ${whatIfPay.toFixed(2)}</div>
                                                <div
                                                    className={`font-medium ${whatIfPay > takeHomePay
                                                        ? "text-green-600"
                                                        : "text-red-600"
                                                        }`}
                                                >
                                                    📊 Difference: {whatIfPay > takeHomePay ? "+" : ""}$
                                                    {(whatIfPay - takeHomePay).toFixed(2)}
                                                </div>
                                                <div className="text-xs mt-1">
                                                    📈 Annual impact:{" "}
                                                    {whatIfPay > takeHomePay ? "+" : ""}$
                                                    {((whatIfPay - takeHomePay) * 26).toLocaleString()}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Quick Stats Grid */}
                                    <div className="mt-4">
                                        <hr
                                            className={`${darkMode ? "border-gray-700" : "border-gray-200"
                                                } mb-3`}
                                        />
                                        <div className="space-y-2">
                                            <div className="flex items-center text-sm font-medium">
                                                <span className="mr-2">📈</span>
                                                <span>Quick Stats</span>
                                            </div>
                                            <div className="grid grid-cols-3 gap-2 text-xs">
                                                <div
                                                    className={`p-2 rounded text-center ${darkMode ? "bg-purple-800" : "bg-purple-100"
                                                        }`}
                                                >
                                                    <div className="font-medium">
                                                        {categorizedExpenses.length}
                                                    </div>
                                                    <div className="text-purple-600 dark:text-purple-400">
                                                        Categories
                                                    </div>
                                                </div>
                                                <div
                                                    className={`p-2 rounded text-center ${darkMode ? "bg-blue-800" : "bg-blue-100"
                                                        }`}
                                                >
                                                    <div className="font-medium">{expenses.length}</div>
                                                    <div className="text-blue-600 dark:text-blue-400">
                                                        Expenses
                                                    </div>
                                                </div>
                                                <div
                                                    className={`p-2 rounded text-center ${darkMode ? "bg-green-800" : "bg-green-100"
                                                        }`}
                                                >
                                                    <div className="font-medium">
                                                        {savingsGoals.length}
                                                    </div>
                                                    <div className="text-green-600 dark:text-green-400">
                                                        Goals
                                                    </div>
                                                </div>
                                                <div
                                                    className={`p-2 rounded text-center ${darkMode ? "bg-yellow-800" : "bg-yellow-100"
                                                        }`}
                                                >
                                                    <div className="font-medium">
                                                        {calculations.expenseAllocations.filter(
                                                            (e) => e.isFullyFunded
                                                        ).length +
                                                            calculations.goalAllocations.filter(
                                                                (g) => g.isFullyFunded
                                                            ).length}
                                                    </div>
                                                    <div className="text-yellow-600 dark:text-yellow-400">
                                                        Funded
                                                    </div>
                                                </div>
                                                <div
                                                    className={`p-2 rounded text-center ${darkMode ? "bg-orange-800" : "bg-orange-100"
                                                        }`}
                                                >
                                                    <div className="font-medium">
                                                        {calculations.expenseAllocations.filter(
                                                            (e) => e.priorityState === "paused"
                                                        ).length +
                                                            calculations.goalAllocations.filter(
                                                                (g) => g.priorityState === "paused"
                                                            ).length}
                                                    </div>
                                                    <div className="text-orange-600 dark:text-orange-400">
                                                        Paused
                                                    </div>
                                                </div>
                                                <div
                                                    className={`p-2 rounded text-center ${darkMode ? "bg-indigo-800" : "bg-indigo-100"
                                                        }`}
                                                >
                                                    <div className="font-medium">
                                                        {calculations.expenseAllocations.filter(
                                                            (e) => e.priorityState === "complete"
                                                        ).length +
                                                            calculations.goalAllocations.filter(
                                                                (g) => g.priorityState === "complete"
                                                            ).length}
                                                    </div>
                                                    <div className="text-indigo-600 dark:text-indigo-400">
                                                        Complete
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Annual Projections */}
                                    <div className="mt-4">
                                        <hr
                                            className={`${darkMode ? "border-gray-700" : "border-gray-200"
                                                } mb-3`}
                                        />
                                        <div className="space-y-2">
                                            <div className="flex items-center text-sm font-medium">
                                                <span className="mr-2">📅</span>
                                                <span>Annual Projections</span>
                                            </div>
                                            <div className="space-y-1 text-xs">
                                                <div className="flex justify-between">
                                                    <span>💰 Annual Income:</span>
                                                    <span className="font-medium">
                                                        ${(currentPay * 26).toLocaleString()}
                                                    </span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span>💸 Annual Allocations:</span>
                                                    <span className="font-medium">
                                                        $
                                                        {(
                                                            calculations.totalWithBuffer * 26
                                                        ).toLocaleString()}
                                                    </span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span>💚 Annual Remaining:</span>
                                                    <span
                                                        className={`font-medium ${calculations.remainingIncome >= 0
                                                            ? "text-green-400"
                                                            : "text-red-400"
                                                            }`}
                                                    >
                                                        $
                                                        {(
                                                            calculations.remainingIncome * 26
                                                        ).toLocaleString()}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Add Transaction Modal */}
                        {showAddTransaction && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                <div
                                    className={`${darkMode ? "bg-gray-800" : "bg-white"
                                        } p-6 rounded-lg w-96 max-h-[90vh] overflow-y-auto`}
                                >
                                    <h3 className="text-lg font-semibold mb-4">
                                        Add New Transaction
                                    </h3>
                                    <AddTransactionForm
                                        onSave={(transactionData, addAnother) => {
                                            const newTransaction = {
                                                ...transactionData,
                                                id: Math.max(...transactions.map((t) => t.id), 0) + 1,
                                            };
                                            setTransactions((prev) => [...prev, newTransaction]);
                                            if (!addAnother) setShowAddTransaction(false);
                                        }}
                                        onCancel={() => setShowAddTransaction(false)}
                                        categories={categories}
                                        accounts={accounts}
                                        darkMode={darkMode}
                                    />
                                </div>
                            </div>
                        )}

                        {editingTransaction && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                <div
                                    className={`${darkMode ? "bg-gray-800" : "bg-white"
                                        } p-6 rounded-lg w-96 max-h-[90vh] overflow-y-auto`}
                                >
                                    <h3 className="text-lg font-semibold mb-4">
                                        Edit Transaction
                                    </h3>
                                    <AddTransactionForm
                                        transaction={editingTransaction}
                                        onSave={(transactionData) => {
                                            setTransactions((prev) =>
                                                prev.map((txn) =>
                                                    txn.id === editingTransaction.id
                                                        ? { ...txn, ...transactionData }
                                                        : txn
                                                )
                                            );
                                            setEditingTransaction(null);
                                        }}
                                        onCancel={() => setEditingTransaction(null)}
                                        categories={categories}
                                        accounts={accounts}
                                        darkMode={darkMode}
                                    />
                                </div>
                            </div>
                        )}

                        {/* All Transactions Modal */}
                        {showTransactions && (
                            <div
                                className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-2 sm:p-4"
                                onClick={(e) =>
                                    e.target === e.currentTarget && setShowTransactions(false)
                                }
                                onKeyDown={(e) =>
                                    e.key === "Escape" && setShowTransactions(false)
                                }
                                tabIndex={-1}
                            >
                                <div
                                    className={`${darkMode ? "bg-gray-800" : "bg-white"
                                        } rounded-lg w-full max-w-4xl h-[95vh] sm:h-[85vh] overflow-hidden flex flex-col`}
                                >
                                    <div className="p-4 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                                        <div className="flex justify-between items-center mb-3">
                                            <h3 className="text-lg font-semibold flex items-center">
                                                💳 All Transactions
                                            </h3>
                                            <button
                                                onClick={() => setShowTransactions(false)}
                                                className="text-gray-400 hover:text-gray-600 text-xl font-bold"
                                            >
                                                ✕
                                            </button>
                                        </div>

                                        <div className="flex space-x-4 items-center">
                                            <select
                                                value={selectedAccount}
                                                onChange={(e) => setSelectedAccount(e.target.value)}
                                                className={`p-2 border rounded text-sm ${darkMode
                                                    ? "bg-gray-700 border-gray-600"
                                                    : "bg-white border-gray-300"
                                                    }`}
                                            >
                                                <option value="all">All Accounts</option>
                                                {accounts.map((account) => (
                                                    <option key={account.id} value={account.id}>
                                                        {account.name}
                                                    </option>
                                                ))}
                                            </select>
                                            <button
                                                onClick={() => setShowAddTransaction(true)}
                                                className="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 flex items-center"
                                            >
                                                <Plus className="w-4 h-4 mr-1" />
                                                Add Transaction
                                            </button>
                                        </div>
                                    </div>

                                    <div className="flex-1 overflow-y-auto p-4">
                                        <div className="space-y-2">
                                            {transactions
                                                .filter(
                                                    (txn) =>
                                                        selectedAccount === "all" ||
                                                        txn.accountId === parseInt(selectedAccount)
                                                )
                                                .sort((a, b) => new Date(b.date) - new Date(a.date))
                                                .map((transaction) => {
                                                    const account = accounts.find(
                                                        (acc) => acc.id === transaction.accountId
                                                    );
                                                    const category = categories.find(
                                                        (cat) => cat.id === transaction.categoryId
                                                    );
                                                    const transferAccount =
                                                        transaction.transferAccountId
                                                            ? accounts.find(
                                                                (acc) =>
                                                                    acc.id === transaction.transferAccountId
                                                            )
                                                            : null;

                                                    return (
                                                        <div
                                                            key={transaction.id}
                                                            className={`p-4 rounded border ${darkMode
                                                                ? "border-gray-600 bg-gray-700"
                                                                : "border-gray-200 bg-gray-50"
                                                                }`}
                                                        >
                                                            <div className="flex items-center justify-between">
                                                                <div className="flex-1">
                                                                    <div className="flex items-center">
                                                                        <span className="font-medium">
                                                                            {transaction.transfer
                                                                                ? `Transfer to ${transferAccount?.name}`
                                                                                : transaction.payee}
                                                                        </span>
                                                                        {transaction.cleared && (
                                                                            <span className="ml-2 text-green-500">
                                                                                ✓
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                    <div className="text-sm text-gray-500 mt-1">
                                                                        {transaction.date} • {account?.name}{" "}
                                                                        {category && `• ${category.name}`}
                                                                    </div>
                                                                    {transaction.memo && (
                                                                        <div className="text-sm text-gray-400 mt-1">
                                                                            {transaction.memo}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                                <div className="text-right ml-4">
                                                                    <div className="font-semibold text-lg">
                                                                        ${transaction.amount.toFixed(2)}
                                                                    </div>
                                                                    <div className="flex space-x-1 mt-1">
                                                                        <button
                                                                            onClick={() =>
                                                                                setEditingTransaction(transaction)
                                                                            }
                                                                            className="p-1 hover:bg-gray-600 rounded"
                                                                        >
                                                                            <Edit2 className="w-4 h-4" />
                                                                        </button>
                                                                        <button
                                                                            onClick={() =>
                                                                                setConfirmDelete({
                                                                                    type: "transaction",
                                                                                    id: transaction.id,
                                                                                    name: transaction.transfer
                                                                                        ? `Transfer to ${transferAccount?.name}`
                                                                                        : transaction.payee,
                                                                                    message: `Delete this transaction?`,
                                                                                })
                                                                            }
                                                                            className="p-1 hover:bg-gray-600 rounded text-red-400"
                                                                        >
                                                                            <Trash2 className="w-4 h-4" />
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            {transactions.length === 0 && (
                                                <p className="text-gray-500 text-center py-8">
                                                    No transactions yet. Add your first transaction to
                                                    get started!
                                                </p>
                                            )}
                                        </div>
                                    </div>

                                    <div className="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end flex-shrink-0">
                                        <button
                                            onClick={() => setShowTransactions(false)}
                                            className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                                        >
                                            Done
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Add Expense Modal */}
                        {showAddExpense && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                <div
                                    className={`${darkMode ? "bg-gray-800" : "bg-white"
                                        } p-6 rounded-lg w-96 max-h-[90vh] overflow-y-auto`}
                                >
                                    <h3 className="text-lg font-semibold mb-4">
                                        Add New Expense
                                    </h3>
                                    <AddExpenseForm
                                        onSave={(expenseData, addAnother) => {
                                            const newExpense = {
                                                ...expenseData,
                                                id: Math.max(...expenses.map((e) => e.id), 0) + 1,
                                                collapsed: true,
                                            };
                                            setExpenses((prev) => [...prev, newExpense]);
                                            if (!addAnother) {
                                                setShowAddExpense(false);
                                                setPreselectedCategory(null);
                                            }
                                        }}
                                        onCancel={() => {
                                            setShowAddExpense(false);
                                            setPreselectedCategory(null);
                                        }}
                                        categories={categories}
                                        darkMode={darkMode}
                                        currentPay={currentPay}
                                        preselectedCategory={preselectedCategory}
                                    />
                                </div>
                            </div>
                        )}

                        {editingExpense && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                <div
                                    className={`${darkMode ? "bg-gray-800" : "bg-white"
                                        } p-6 rounded-lg w-96 max-h-[90vh] overflow-y-auto`}
                                >
                                    <h3 className="text-lg font-semibold mb-4">Edit Expense</h3>
                                    <AddExpenseForm
                                        expense={editingExpense}
                                        onSave={(expenseData) => {
                                            setExpenses((prev) =>
                                                prev.map((exp) =>
                                                    exp.id === editingExpense.id
                                                        ? { ...exp, ...expenseData }
                                                        : exp
                                                )
                                            );
                                            setEditingExpense(null);
                                        }}
                                        onCancel={() => setEditingExpense(null)}
                                        categories={categories}
                                        darkMode={darkMode}
                                        currentPay={currentPay}
                                    />
                                </div>
                            </div>
                        )}

                        {showAddCategory && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                <div
                                    className={`${darkMode ? "bg-gray-800" : "bg-white"
                                        } p-6 rounded-lg w-96`}
                                >
                                    <h3 className="text-lg font-semibold mb-4">
                                        Add New Category
                                    </h3>
                                    <AddCategoryForm
                                        onSave={(categoryData, addAnother) => {
                                            const newCategory = {
                                                ...categoryData,
                                                id: Math.max(...categories.map((c) => c.id), 0) + 1,
                                                collapsed: false,
                                            };
                                            setCategories((prev) => [...prev, newCategory]);
                                            if (!addAnother) setShowAddCategory(false);
                                        }}
                                        onCancel={() => setShowAddCategory(false)}
                                        categoryColors={categoryColors}
                                        darkMode={darkMode}
                                    />
                                </div>
                            </div>
                        )}

                        {editingCategory && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                <div
                                    className={`${darkMode ? "bg-gray-800" : "bg-white"
                                        } p-6 rounded-lg w-96`}
                                >
                                    <h3 className="text-lg font-semibold mb-4">
                                        Edit Category
                                    </h3>
                                    <AddCategoryForm
                                        category={editingCategory}
                                        onSave={(categoryData) => {
                                            setCategories((prev) =>
                                                prev.map((cat) =>
                                                    cat.id === editingCategory.id
                                                        ? { ...cat, ...categoryData }
                                                        : cat
                                                )
                                            );
                                            setEditingCategory(null);
                                        }}
                                        onCancel={() => setEditingCategory(null)}
                                        categoryColors={categoryColors}
                                        darkMode={darkMode}
                                    />
                                </div>
                            </div>
                        )}
                        {/* Add Account Modal */}
                        {showAddAccount && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                <div
                                    className={`${darkMode ? "bg-gray-800" : "bg-white"
                                        } p-6 rounded-lg w-96`}
                                >
                                    <h3 className="text-lg font-semibold mb-4">
                                        Add New Account
                                    </h3>
                                    <AddAccountForm
                                        onSave={(accountData) => {
                                            const newAccount = {
                                                ...accountData,
                                                id: Math.max(...accounts.map((a) => a.id), 0) + 1,
                                            };
                                            setAccounts((prev) => [...prev, newAccount]);
                                            setShowAddAccount(false);
                                        }}
                                        onCancel={() => setShowAddAccount(false)}
                                        darkMode={darkMode}
                                    />
                                </div>
                            </div>
                        )}
                        {editingAccount && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                <div
                                    className={`${darkMode ? "bg-gray-800" : "bg-white"
                                        } p-6 rounded-lg w-96`}
                                >
                                    <h3 className="text-lg font-semibold mb-4">Edit Account</h3>
                                    <AddAccountForm
                                        account={editingAccount}
                                        onSave={(accountData) => {
                                            setAccounts((prev) =>
                                                prev.map((acc) =>
                                                    acc.id === editingAccount.id
                                                        ? { ...acc, ...accountData }
                                                        : acc
                                                )
                                            );
                                            setEditingAccount(null);
                                        }}
                                        onCancel={() => setEditingAccount(null)}
                                        darkMode={darkMode}
                                    />
                                </div>
                            </div>
                        )}
                        {/* Add Goal Modal */}
                        {showAddGoal && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                <div
                                    className={`${darkMode ? "bg-gray-800" : "bg-white"
                                        } p-6 rounded-lg w-96 max-h-[90vh] overflow-y-auto`}
                                >
                                    <h3 className="text-lg font-semibold mb-4">
                                        Add Savings Goal
                                    </h3>
                                    <GoalForm
                                        onSave={(goalData, addAnother) => {
                                            const newGoal = {
                                                ...goalData,
                                                id: Math.max(...savingsGoals.map((g) => g.id), 0) + 1,
                                                collapsed: true,
                                            };
                                            setSavingsGoals((prev) => [...prev, newGoal]);
                                            if (!addAnother) {
                                                setShowAddGoal(false);
                                                setPreselectedCategory(null);
                                            }
                                        }}
                                        onCancel={() => {
                                            setShowAddGoal(false);
                                            setPreselectedCategory(null);
                                        }}
                                        categories={categories}
                                        darkMode={darkMode}
                                        currentPay={currentPay}
                                        preselectedCategory={preselectedCategory}
                                    />
                                </div>
                            </div>
                        )}

                        {editingGoal && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg w-96 max-h-[90vh] overflow-y-auto`}>
                                    <h3 className="text-lg font-semibold mb-4">Edit Savings Goal</h3>
                                    <GoalForm
                                        goal={editingGoal}
                                        onSave={(goalData) => {
                                            setSavingsGoals(prev => prev.map(g => g.id === editingGoal.id ? { ...g, ...goalData } : g));
                                            setEditingGoal(null);
                                        }}
                                        onCancel={() => setEditingGoal(null)}
                                        categories={categories}
                                        darkMode={darkMode}
                                        currentPay={currentPay}
                                    />
                                </div>
                            </div>
                        )}
                        {/* Calendar Modal */}
                        {showCalendar && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                                <div
                                    className={`${darkMode ? "bg-gray-800" : "bg-white"
                                        } rounded-lg w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col p-6`}
                                    onKeyDown={(e) => {
                                        if (e.key === "Escape") {
                                            setShowCalendar(false);
                                        }
                                    }}
                                    tabIndex={0}
                                    ref={(el) => el && el.focus()}
                                >
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-lg font-semibold">Calendar Test</h3>
                                        <button
                                            onClick={() => setShowCalendar(false)}
                                            className="text-gray-400 hover:text-gray-600 text-xl font-bold"
                                        >
                                            ✕
                                        </button>
                                    </div>

                                    <CalendarView
                                        events={[]}
                                        darkMode={darkMode}
                                        currentPay={currentPay}
                                        paySchedule={paySchedule}
                                        savingsGoals={savingsGoals}
                                        expenses={expenses}
                                        categories={categories}
                                        frequencyOptions={frequencyOptions}
                                        accounts={accounts}
                                    />

                                    <button
                                        onClick={() => setShowCalendar(false)}
                                        className="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Custom Confirmation Dialog */}
                        {confirmDelete && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                <div
                                    className={`${darkMode ? "bg-gray-800" : "bg-white"
                                        } p-6 rounded-lg w-96`}
                                >
                                    <h3 className="text-lg font-semibold mb-4">
                                        Confirm Delete
                                    </h3>
                                    <p className="mb-6">{confirmDelete.message}</p>
                                    <div className="flex space-x-2">
                                        <button
                                            onClick={() => {
                                                if (confirmDelete.type === "expense") {
                                                    deleteExpense(confirmDelete.id);
                                                } else if (confirmDelete.type === "goal") {
                                                    setSavingsGoals(
                                                        savingsGoals.filter(
                                                            (goal) => goal.id !== confirmDelete.id
                                                        )
                                                    );
                                                    setConfirmDelete(null);
                                                } else if (confirmDelete.type === "category") {
                                                    deleteCategory(confirmDelete.id);
                                                } else if (confirmDelete.type === "account") {
                                                    deleteAccount(confirmDelete.id);
                                                } else if (confirmDelete.type === "transaction") {
                                                    deleteTransaction(confirmDelete.id);
                                                }
                                            }}
                                            className="flex-1 bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700"
                                        >
                                            Delete
                                        </button>
                                        <button
                                            onClick={() => setConfirmDelete(null)}
                                            className={`flex-1 py-2 px-4 rounded border ${darkMode
                                                ? "border-gray-600 hover:bg-gray-700"
                                                : "border-gray-300 hover:bg-gray-50"
                                                }`}
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(
            <BiweeklyBudgetCalculator />,
            document.getElementById("root")
        );
    </script>
</body>

</html>